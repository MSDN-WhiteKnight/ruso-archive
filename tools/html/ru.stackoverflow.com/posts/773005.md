---
title: "Post 773005"
---
<p><i><a href="https://github.com/MSDN-WhiteKnight/ruso-archive/">RuSO Archive</a></i></p>
<h1>Post 773005</h1>
<h2>Answer 773005</h2>
<p><a href="https://ru.stackoverflow.com/a/773005/">Source</a> - by <a href="https://ru.stackoverflow.com/users/240512/msdn-whiteknight">MSDN.WhiteKnight</a></p>
<blockquote>
<p>Нужно обнулять память для структуры LVITEM и массива символов перед каждым вызовом <em>WriteProcessMemory</em> / <em>SendMessage</em>.</p>

<p>Данный код позволяет получить текст для всех столбцов ListView:</p>

<pre><code>HWND hSysListView32 = FindWindowEx(hWnd, NULL, L"SysListView32", NULL);

DWORD dwProcessId;
GetWindowThreadProcessId(hSysListView32, &amp;dwProcessId);
HANDLE hProcess = OpenProcess(
PROCESS_VM_READ | PROCESS_VM_WRITE |
PROCESS_VM_OPERATION,
FALSE,
dwProcessId);

if (!hProcess) return -1;

LVITEM* lviAddress = (LVITEM*)VirtualAllocEx(hProcess, NULL, sizeof LVITEM, MEM_COMMIT, PAGE_READWRITE);
LPTSTR pItemText = (LPTSTR)VirtualAllocEx(hProcess, NULL, sizeof TCHAR * 512, MEM_COMMIT, PAGE_READWRITE);

TCHAR itemText[512] = {0};
LVITEM lvItem = { 0 };

for (int i = 0; i &lt; COUNT_ITEMS; i++)
    for(int j=0; j &lt; COUNT_SUBITEMS; j++)
    {

        memset(&amp;itemText,0,sizeof(itemText)); //обнуление памяти
        memset(&amp;lvItem,0,sizeof(LVITEM));

        lvItem.mask = LVIF_TEXT;
        lvItem.iSubItem = j;
        lvItem.iItem = i;
        lvItem.pszText = pItemText;
        lvItem.cchTextMax = 512;

        WriteProcessMemory(hProcess, lviAddress, &amp;lvItem, sizeof(LVITEM), NULL);

        int nSymbolsCount = SendMessage(hSysListView32, LVM_GETITEMTEXT, i, (LPARAM)lviAddress);
        if (nSymbolsCount &gt; 0)
        ReadProcessMemory(hProcess, pItemText, itemText, sizeof TCHAR * nSymbolsCount, NULL);

        wprintf(L"Item %d, subitem %d: %s\n", i,j,itemText);
    }

VirtualFreeEx(hProcess, pItemText, 0, MEM_RELEASE);
VirtualFreeEx(hProcess, lviAddress, 0, MEM_RELEASE);
CloseHandle(hProcess);
</code></pre>

</blockquote>
<hr/>
<p><i>Content is retrieved from StackExchange API. </i></p>
<p><i>Auto-generated by ruso-archive tools. </i></p>
