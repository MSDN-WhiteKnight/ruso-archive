---
title: "C#: фильтрация ip-адресов"
---
<p><i><a href="https://github.com/MSDN-WhiteKnight/ruso-archive/">RuSO Archive</a></i></p>
<h1>C#: фильтрация ip-адресов</h1>
<p><a href="https://ru.stackoverflow.com/questions/830562/c-%d1%84%d0%b8%d0%bb%d1%8c%d1%82%d1%80%d0%b0%d1%86%d0%b8%d1%8f-ip-%d0%b0%d0%b4%d1%80%d0%b5%d1%81%d0%be%d0%b2">Source</a> - by <a href="https://ru.stackoverflow.com/users/286191/eriksongerson">eriksongerson</a></p>
<blockquote>
<p>В программе нужно получить свой ip адрес. Делаю это такой функцией:</p>

<pre><code>public static string GetLocalIPAddress()
{
    var host = Dns.GetHostEntry(Dns.GetHostName());
    foreach (var ip in host.AddressList)
    {
        if (ip.AddressFamily == AddressFamily.InterNetwork)
        {
            return ip.ToString();
        }
    }
    return null;
}
</code></pre>

<p>Но существует следующая проблема: Если на машине установлен виртуальный сетевой адаптер (например, от VirtualBox), то функция выдаёт его ip-адрес. </p>

<p>Можно ли как-нибудь отфильтровать виртуальные адаптеры?</p>

</blockquote>
<h2>Answer 830696</h2>
<p><a href="https://ru.stackoverflow.com/a/830696/">Source</a> - by <a href="https://ru.stackoverflow.com/users/240512/msdn-whiteknight">MSDN.WhiteKnight</a></p>
<blockquote>
<p>Добавьте ссылку на System.Management и используйте WMI-запрос к классу <em>Win32_NetworkAdapter</em>, у реальных интерфейсов должно быть <em>PhysicalAdapter=true</em>. Для получения Guid интерфейса можно использовать <code>NetworkInterface.GetAllNetworkInterfaces()</code>. Как-то так:</p>

<pre><code>using System.Net;
using System.Net.Sockets;
using System.Net.NetworkInformation;
using System.Management;

...

//Определяет, является ли адаптер физическим
public static bool IsAdapterPhysical(string guid)
{
    ManagementObjectCollection mbsList = null;            

    ManagementObjectSearcher mbs = new ManagementObjectSearcher(
    "SELECT PhysicalAdapter FROM Win32_NetworkAdapter WHERE GUID = '" + guid + "'"
    );
    bool res = false;

    using (mbs)
    {
        mbsList = mbs.Get();

        foreach (ManagementObject mo in mbsList)
        {                  
            foreach (var p in mo.Properties)
            {                        
                if (p.Value != null)
                {
                    res = (bool)p.Value;
                    break;
                }
                else res = false;                        
            }                    
        }
        return res;
    }

}

//Получает все локальные IP-адреса
public static List&lt;IPAddress&gt; GetIpAddresses()
{
    List&lt;IPAddress&gt; res = new List&lt;IPAddress&gt;(10);

    var ifs = NetworkInterface.GetAllNetworkInterfaces();

    foreach (var interf in ifs)
    {
        var ipprop=interf.GetIPProperties();
        if (ipprop == null) continue;
        var unicast = ipprop.UnicastAddresses;
        if (unicast == null) continue;

        if (IsAdapterPhysical(interf.Id.ToString()))
        {
            //находим первый Unicast-адрес
            foreach (var addr in unicast)
            {
                if (addr.Address.AddressFamily != AddressFamily.InterNetwork) continue;
                res.Add(addr.Address);
                break;
            }
        }
    }

    return res;
}
</code></pre>

</blockquote>
<hr/>
<p><i>Content is retrieved from StackExchange API. </i></p>
<p><i>Auto-generated by ruso-archive tools. </i></p>
