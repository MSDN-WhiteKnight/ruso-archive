{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":true,"score":2,"last_activity_date":1543817626,"last_edit_date":1543817626,"creation_date":1543814041,"answer_id":914756,"question_id":914740,"body":"<p>Смещения полей в данном случае не зависят от платформы, ведь в структуре нет ни одного указателя. Но дело в том, что .NET по какой-то причине не разрешает работать с некорректно выровненными массивами в структурах при использовании LayoutKind.Explicit. Вам нужно либо использовать <code>StructLayout(LayoutKind.Sequential, Pack = 1)</code> и избавиться от явных смещений, либо включить unsafe-код и объявлять все массивы так:</p>\n\n<pre><code>[FieldOffset(20)]\npublic fixed byte flags[4];\n</code></pre>\n\n<hr>\n\n<p>Полный код:</p>\n\n<pre><code>using System;\nusing System.Runtime.InteropServices;\nusing System.Text;\n\nnamespace ConsoleApp1\n{\n    class Program\n    {\n        public static T ToObject&lt;T&gt;(byte[] structureDataBytes)\n        {\n            T createdObject = default(T);\n\n            var memoryObjectSize = Marshal.SizeOf(typeof(T));\n\n            // Cannot create object from array that is too small.\n            if (memoryObjectSize &gt; structureDataBytes.Length)\n                return createdObject;\n\n            // Reserve unmanaged memory, copy structureDataBytes bytes to there, and convert this unmanaged memory to a managed type.\n            // Then free memory.\n            var reservedMemPtr = Marshal.AllocHGlobal(memoryObjectSize);\n\n            Marshal.Copy(structureDataBytes, 0, reservedMemPtr, memoryObjectSize);\n\n            createdObject = (T)Marshal.PtrToStructure(reservedMemPtr, typeof(T));\n\n            Marshal.FreeHGlobal(reservedMemPtr);\n\n            return createdObject;\n        }\n\n        static void Main(string[] args)\n        {\n            byte[] arr = new byte[2000];\n            arr[0] = 1;\n            arr[1] = 0;\n            arr[2] = 0;\n            arr[3] = 0;\n            Ets2SdkData data = ToObject&lt;Ets2SdkData&gt;(arr);\n            Console.WriteLine(data.time.ToString());                   \n\n            Console.ReadKey();            \n        }\n\n\n\n    }\n\n    [StructLayout(LayoutKind.Explicit, Pack = 1)]\n    public unsafe struct Ets2SdkData\n    {\n        [FieldOffset(0)]\n        public uint time;\n        [FieldOffset(4)]\n        public uint paused;\n\n        [FieldOffset(8)]\n        public uint ets2_telemetry_plugin_revision;\n        [FieldOffset(12)]\n        public uint ets2_version_major;\n        [FieldOffset(16)]\n        public uint ets2_version_minor;\n\n        //***** REVISION 1 ****** //\n\n\n        [FieldOffset(20)]\n        public fixed byte flags[4];\n\n        //vehicle dynamics\n\n        [FieldOffset(24)]\n        public float speed;\n        [FieldOffset(28)]\n        public float accelerationX;\n        [FieldOffset(32)]\n        public float accelerationY;\n        [FieldOffset(36)]\n        public float accelerationZ;\n\n\n        [FieldOffset(40)]\n        public float coordinateX;\n        [FieldOffset(44)]\n        public float coordinateY;\n        [FieldOffset(48)]\n        public float coordinateZ;\n\n\n        [FieldOffset(52)]\n        public float rotationX;\n        [FieldOffset(56)]\n        public float rotationY;\n        [FieldOffset(60)]\n        public float rotationZ;\n\n        //drivetrain essentials\n\n        [FieldOffset(64)]\n        public int gear;\n        [FieldOffset(68)]\n        public int gears;\n        [FieldOffset(72)]\n        public int gearRanges;\n        [FieldOffset(76)]\n        public int gearRangeActive;\n\n        [FieldOffset(80)]\n        public float engineRpm;\n        [FieldOffset(84)]\n        public float engineRpmMax;\n\n        [FieldOffset(88)]\n        public float fuel;\n        [FieldOffset(92)]\n        public float fuelCapacity;\n        [FieldOffset(96)]\n        public float fuelRate;\n        [FieldOffset(100)]\n        public float fuelAvgConsumption;\n\n        // user input\n\n        [FieldOffset(104)]\n        public float userSteer;\n        [FieldOffset(108)]\n        public float userThrottle;\n        [FieldOffset(112)]\n        public float userBrake;\n        [FieldOffset(116)]\n        public float userClutch;\n\n\n        [FieldOffset(120)]\n        public float gameSteer;\n        [FieldOffset(124)]\n        public float gameThrottle;\n        [FieldOffset(128)]\n        public float gameBrake;\n        [FieldOffset(132)]\n        public float gameClutch;\n\n        //truck &amp; trailer\n\n        [FieldOffset(136)]\n        public float truckWeight;\n        [FieldOffset(140)]\n        public float trailerWeight;\n\n        [FieldOffset(144)]\n        public int modelOffset;\n        [FieldOffset(148)]\n        public int modelLength;\n\n        [FieldOffset(152)]\n        public int trailerOffset;\n        [FieldOffset(156)]\n        public int trailerLength;\n\n\n        //***** REVISION 2 ****** //\n        [FieldOffset(160)]\n        public int timeAbsolute;\n        [FieldOffset(164)]\n        public int gearsReverse;\n\n        [FieldOffset(168)]\n        public float trailerMass;\n        [FieldOffset(172)]\n        public fixed byte trailerId[64];\n        [FieldOffset(236)]\n        public fixed byte trailerName[64];\n\n        [FieldOffset(300)]\n        public int jobIncome;\n        [FieldOffset(304)]\n        public int jobDeadline;\n\n        [FieldOffset(308)]\n        public fixed byte jobCitySource[64];\n        [FieldOffset(372)]\n        public fixed byte jobCityDestination[64];\n\n        [FieldOffset(436)]\n        public fixed byte jobCompanySource[64];\n        [FieldOffset(500)]\n        public fixed byte jobCompanyDestination[64];\n\n        //***** REVISION 3 ****** //\n        [FieldOffset(564)]\n        public int retarderBrake;\n        [FieldOffset(568)]\n        public int shifterSlot;\n        [FieldOffset(572)]\n        public int shifterToggle;\n        [FieldOffset(576)]\n        public int fill;\n\n        [FieldOffset(580)]\n        public fixed byte aux[24];\n        [FieldOffset(604)]\n        public float airPressure;\n        [FieldOffset(608)]\n        public float brakeTemperature;\n        [FieldOffset(612)]\n        public int fuelWarning;\n        [FieldOffset(616)]\n        public float adblue;\n        [FieldOffset(620)]\n        public float adblueConsumption;\n        [FieldOffset(624)]\n        public float oilPressure;\n        [FieldOffset(628)]\n        public float oilTemperature;\n        [FieldOffset(632)]\n        public float waterTemperature;\n        [FieldOffset(636)]\n        public float batteryVoltage;\n        [FieldOffset(640)]\n        public float lightsDashboard;\n        [FieldOffset(644)]\n        public float wearEngine;\n        [FieldOffset(648)]\n        public float wearTransmission;\n        [FieldOffset(652)]\n        public float wearCabin;\n        [FieldOffset(656)]\n        public float wearChassis;\n        [FieldOffset(660)]\n        public float wearWheels;\n        [FieldOffset(664)]\n        public float wearTrailer;\n        [FieldOffset(668)]\n        public float truckOdometer;\n        [FieldOffset(672)]\n        public float cruiseControlSpeed;\n\n        [FieldOffset(676)]\n        public fixed byte truckMake[64];\n        [FieldOffset(740)]\n        public fixed byte truckMakeId[64];\n        [FieldOffset(804)]\n        public fixed byte truckModel[64];\n\n        // ***** REVISION 4 ****** //\n        [FieldOffset(868)]\n        public float speedLimit;\n\n        [FieldOffset(872)]\n        public float routeDistance;\n\n        [FieldOffset(876)]\n        public float routeTime;\n\n        [FieldOffset(880)]\n        public float fuelRange;\n\n        [FieldOffset(884)]\n        public fixed float gearRatioForward[24];\n\n        [FieldOffset(980)]\n        public fixed float gearRatioReverse[8];\n\n        [FieldOffset(1012)]\n        public float gearRatioDifferential;\n\n        [FieldOffset(1016)]\n        public int gearDashboard;\n\n        [FieldOffset(1020)]\n        public byte onJob;\n        [FieldOffset(1021)]\n        public byte jobFinished;        \n    }\n\n\n}\n</code></pre>\n"}