---
title: "Настройка формата аудиоустройства в Windows"
se.owner.user_id: 248508
se.owner.display_name: "Dmitry"
se.owner.link: "https://ru.stackoverflow.com/users/248508/dmitry"
se.link: "https://ru.stackoverflow.com/questions/661489/%d0%9d%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82%d0%b0-%d0%b0%d1%83%d0%b4%d0%b8%d0%be%d1%83%d1%81%d1%82%d1%80%d0%be%d0%b9%d1%81%d1%82%d0%b2%d0%b0-%d0%b2-windows"
se.question_id: 661489
se.post_type: question
se.score: 4
---
<p>Я разрабатываю приложение для аудиоустройства, работающего по стандарту usb audio. Одной из задач является выбор формата воспроизведения: количество бит, частота дискретизации. Для задания формата, используя Windows Core Audio API, я написал следующий c++ код:</p>

<pre><code>bool CPropPage::SetMode(int freq, int bits)
{
    static const int channels = 2;
    PROPVARIANT varName;
    IMMDevice* pDev = NULL;
    IPropertyStore *pProps = NULL;
    bool result = false;

    if (!m_pEnumerator)
        return false;

    HRESULT hr = m_pEnumerator-&gt;GetDevice(m_devguid.c_str(), &amp;pDev);
    if (hr != S_OK)
        return false;

    hr = pDev-&gt;OpenPropertyStore(STGM_WRITE, &amp;pProps);
    if (hr != S_OK)
        goto exit;

    PropVariantInit(&amp;varName);
    varName.vt = VT_BLOB;
    varName.blob.cbSize = sizeof(WAVEFORMATEXTENSIBLE);
    int alignment = channels * bits / 8;
    WAVEFORMATEXTENSIBLE format = {
        {
            WAVE_FORMAT_EXTENSIBLE,
            channels,
            freq,
            freq * alignment,
            alignment,
            bits,
            (sizeof(WAVEFORMATEXTENSIBLE) - sizeof(WAVEFORMATEX))
        },
        {bits},
        SPEAKER_FRONT_LEFT | SPEAKER_FRONT_RIGHT,
        KSDATAFORMAT_SUBTYPE_PCM
    };
    varName.blob.pBlobData = (BYTE*)&amp;format;

    LogEntry("SetMode:%d %d\n", freq, bits);
    hr = pProps-&gt;SetValue(
        PKEY_AudioEngine_DeviceFormat, varName);
    if (hr != S_OK)
        goto exit;
    LogEntry("SetMode ok\n");

    LogAudioEngineFormat(pDev, &amp;format.Format);

    result = true;

exit:
    if (pDev) pDev-&gt;Release();
    if (pProps) pProps-&gt;Release();
    return result;
}
</code></pre>

<p>По сути, работа функции сводится к заданию свойства <code>PKEY_AudioEngine_DeviceFormat</code> объекта <code>IMMDevice</code>.</p>

<p>Примечание. <code>m_pEnumerator</code> - указатель на объект COM-класса <code>IMMDeviceEnumerator</code>. <code>m_devguid</code> - GUID устройства.</p>

<p>Результат работы функции: формат задается, и это видно в Панель управления -> Звук -> Свойства. Однако при этом невозможно воспроизвести ни один звук. Windows Media Player сообщает, что данный формат не поддерживается. (Задаваемый формат: 44100 Гц, 2 канала, 16 бит).
При этом, если тот же самый формат задать через Панель управления -> Звук -> Свойства, все звуки, аудиофайлы воспроизводятся успешно.</p>

<p>Что я делаю не так?</p>
