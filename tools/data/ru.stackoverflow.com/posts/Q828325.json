{"tags":["c#","https","tls"],"owner":{"reputation":1430,"user_id":238013,"user_type":"registered","accept_rate":64,"profile_image":"https://www.gravatar.com/avatar/d4dab84aa4c67525aecd5da391a8e68a?s=128&d=identicon&r=PG&f=1","display_name":"D .Stark","link":"https://ru.stackoverflow.com/users/238013/d-stark"},"is_answered":true,"view_count":76,"answer_count":2,"score":0,"last_activity_date":1526466455,"creation_date":1526406454,"question_id":828325,"link":"https://ru.stackoverflow.com/questions/828325/%d0%9e%d1%88%d0%b8%d0%b1%d0%ba%d0%b0-%d0%bf%d1%80%d0%b8-%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b5-%d1%81%d1%82%d1%80%d0%b0%d0%bd%d0%b8%d1%86%d1%8b-%d0%b2%d1%85%d0%be%d0%b4%d0%b0-%d0%bd%d0%b0-%d1%81%d0%b0%d0%b9%d1%82%d0%b5","title":"Ошибка при загрузке страницы входа на сайте","body":"<p>Пытаемся получить корректный ответ от веб-сервера:</p>\n\n<pre><code>Socket socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);\nsocket.Connect(new IPEndPoint(ipAddress, 443));\nNetworkStream networkStream = new NetworkStream(socket);\n\nSslStream sslStream = new SslStream(networkStream);\nsslStream.ReadTimeout = -1;\nsslStream.WriteTimeout = -1;\nsslStream.AuthenticateAsClient(host);\n\n// Load login page.\n\nsbRequest = new StringBuilder();\nsbRequest.Append(\"GET /auth/login-page HTTP/1.1\\r\\n\");\nsbRequest.Append($\"Host: {host}\\r\\n\\r\\n\");\nsslStream.Send(Encoding.UTF8.GetBytes(sbRequest.ToString()));\nsslStream.Flush();\n\n// Read web-server response.\n\nSystem.Threading.Thread.Sleep(200);\n\n// (read the first 1024 bytes - all headers and the page beginning)\nbyte[] data = new byte[1024];\nsslStream.Read(data, 0, 1024);\nConsole.WriteLine(Encoding.UTF8.GetString(data));\n</code></pre>\n\n<p>Итог общения:</p>\n\n<pre><code>REQUEST:\n--------------------------------------------------\nGET /auth/login-page HTTP/1.1\nHost: [host]\n\n--------------------------------------------------\n\nRESPONSE\n--------------------------------------------------\nHTTP/1.1 200 OK\nServer: nginx/1.6.2\nDate: Tue, 15 May 2018 17:35:40 GMT\nContent-Type: text/html; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nVary: Accept-Encoding\nVary: Cookie\nStrict-Transport-Security: max-age=15768000\n\n1f66\n&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"&gt;\n&lt;html xmlns=\"http://www.w3.org/1999/xhtml\"&gt;\n&lt;head&gt;\n    &lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /&gt;\n    &lt;meta ...\n</code></pre>\n\n<p>Где, собственно, Content-Length? Что за \"1f66\"?..</p>\n\n<p>Дабы проверить как это делает браузер (ведь у него же всё получается), посмотрел Fiddler'ом как сайт отвечает на его запросы:</p>\n\n<pre><code>REQUEST:\n--------------------------------------------------\nGET /auth/login-page HTTP/1.1\nHost: [host]\nConnection: keep-alive\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nDNT: 1\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7\n\n--------------------------------------------------\n\nRESPONSE:\n--------------------------------------------------\nHTTP/1.1 200 OK\nServer: nginx/1.6.2\nDate: Tue, 15 May 2018 16:59:29 GMT\nContent-Type: text/html; charset=utf-8\nConnection: keep-alive\nVary: Accept-Encoding\nVary: Cookie\nStrict-Transport-Security: max-age=15768000\nContent-Length: 8992\n\n&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"&gt;\n&lt;html xmlns=\"http://www.w3.org/1999/xhtml\"&gt;\n&lt;head&gt;\n    &lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /&gt;\n    &lt;meta ...\n</code></pre>\n\n<p>Сделал точно такой же запрос из своей программы, но ответ пришёл ещё хуже:</p>\n\n<pre><code>REQUEST:\n--------------------------------------------------\nGET /auth/login-page HTTP/1.1\nHost: [host]\nConnection: keep-alive\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent:Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nDNT: 1\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7\n\n--------------------------------------------------\n\nRESPONSE\n--------------------------------------------------\nHTTP/1.1 200 OK\nServer: nginx/1.6.2\nDate: Tue, 15 May 2018 17:44:32 GMT\nContent-Type: text/html; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nVary: Accept-Encoding\nVary: Cookie\nStrict-Transport-Security: max-age=15768000\nContent-Encoding: gzip\n\n8fc\n...\n</code></pre>\n\n<p>Кракозябры в конце. Видимо из-за <code>Content-Encoding: gzip</code>... Посылаем такой же запрос, а ответ приходить другой.</p>\n"}