{"owner":{"reputation":2952,"user_id":22836,"user_type":"registered","accept_rate":79,"profile_image":"https://i.stack.imgur.com/EmmZL.png?s=128&g=1","display_name":"4per","link":"https://ru.stackoverflow.com/users/22836/4per"},"is_accepted":true,"score":9,"last_activity_date":1571039008,"creation_date":1571039008,"answer_id":1034402,"question_id":1030195,"body":"<p>Нарисуем форму, бросим панель <code>Dock = Top</code>. На неё два ToolStripEx.</p>\n\n<pre><code>/// &lt;summary&gt;\n/// Вылечена часть глюков ToolStrip с фокусом\n/// &lt;/summary&gt;\npublic class ToolStripEx : ToolStrip\n{\n    protected override void WndProc(ref Message m)\n    {\n        base.WndProc(ref m);\n\n        if (m.Msg == WinApi.WM_MOUSEACTIVATE &amp;&amp;\n            m.Result == (IntPtr)WinApi.MA_ACTIVATEANDEAT)\n        {\n            m.Result = (IntPtr)WinApi.MA_ACTIVATE;\n        }            \n    }\n}\n</code></pre>\n\n<p>Настройка свойств: </p>\n\n<p>левое <code>GripStyle = Hidden, RenderMode = System, Dock = Fill</code></p>\n\n<p>правое <code>GripStyle = Hidden, RenderMode = System, Dock = Fill, LayoutStyle = Flow</code></p>\n\n<p>На левом разместим:</p>\n\n<ul>\n<li>кнопку имитирующую системное меню окна,</li>\n<li>кнопки самого меню, которое нас интересовало,</li>\n<li>ToolStripLabel, который будет играть роль заголовка окна</li>\n</ul>\n\n<p>На правом кидаем кнопки, которые будут имитировать штатный ControlBox.\nПолучилось вот так.</p>\n\n<p><a href=\"https://i.stack.imgur.com/yo2HB.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/yo2HB.png\" alt=\"скриншот формы приложения в дизайн-тайм\"></a>\n<a href=\"https://i.stack.imgur.com/LeRip.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/LeRip.png\" alt=\"скриншот &quot;Структуры документа&quot; для формы\"></a></p>\n\n<p>Теперь собственно нужно убрать заголовок, а имитатору обеспечить схожее поведение.</p>\n\n<p>Самое простое -- это нажатия ControlBox и двойной клик по \"заголовку-имитатору\".</p>\n\n<pre><code>private void toolStripTitle_DoubleClick(object sender, EventArgs e)\n{\n    WindowState = WindowState == FormWindowState.Maximized ?\n                   FormWindowState.Normal\n                   : FormWindowState.Maximized;\n    UpdateControlBox();\n}\n\nprivate void toolStripButtonClose_Click(object sender, EventArgs e)\n{\n    Close();\n}\n\nprivate void toolStripButtonMaximize_Click(object sender, EventArgs e)\n{\n    WindowState = FormWindowState.Maximized;\n    UpdateControlBox();\n}\n\nprivate void toolStripButtonMinimize_Click(object sender, EventArgs e)\n{\n    this.WindowState = FormWindowState.Minimized;\n}\n\nprivate void toolStripButtonRestore_Click(object sender, EventArgs e)\n{\n    WindowState = FormWindowState.Normal;\n    UpdateControlBox();\n}\nprivate void UpdateControlBox()\n{\n    toolStripButtonMaximize.Visible = WindowState != FormWindowState.Maximized;\n    toolStripButtonRestore.Visible = WindowState != FormWindowState.Normal;\n}       \n</code></pre>\n\n<p>Для того, чтобы скрыть родной заголовок, есть три или четыре способа. Но все, кроме одного, страдают недостатками: мы теряем возможность отображать текст в TaskBar, или теряем возможность вызывать \"системное меню окна\".</p>\n\n<p>Мой способ основан на следующем: в дизайнере мы сохраняем стандартный вид окна, затем в обработчике Form.Load захватываем Handle \"системное меню окна\", и только потом с помощью <code>SetWindowLongPtr</code> ликвидируем штатный заголовок.</p>\n\n<pre><code>private IntPtr sysMenuHandle;\nprivate void Form1_Load(object sender, EventArgs e)\n{\n    //Захватываем меню\n    sysMenuHandle = WinApi.GetSystemMenu(this.Handle, false);\n\n    //Ликвидируем штатный заголовок\n    int style = WinApi.GetWindowLongPtr(this.Handle, WinApi.GWL_STYLE).ToInt32();\n    WinApi.SetWindowLongPtr(new HandleRef(this, this.Handle), WinApi.GWL_STYLE,\n        (IntPtr)(style &amp; ~WinApi.WS_CAPTION));\n\n    //Сворачиваем окно и возвращаем как-было\n    //Это костыль, чтобы нормально перерисовалось окно после предыдущей операции\n    //Не помешало бы найти менее корявый способ\n    var winstate = this.WindowState; \n    this.WindowState = FormWindowState.Minimized;\n    this.WindowState = winstate;\n\n    //Обновляем внешний вид ControlBox\n    UpdateControlBox();            \n}\n</code></pre>\n\n<p>Теперь мы сможем вызывать \"системное меню окна\"   </p>\n\n<pre><code>private void toolStripTitle_MouseDown(object sender, MouseEventArgs e)\n{\n    if (e.Button == MouseButtons.Right)\n    {\n        IntPtr hWnd = this.Handle;\n        WinApi.GetWindowRect(hWnd, out WinApi.RECT pos);                \n        int cmd = WinApi.TrackPopupMenu(sysMenuHandle, 0x100,  \n            this.Left + e.X, this.Top + e.Y, 0, hWnd, IntPtr.Zero);\n        if (cmd &gt; 0) WinApi.SendMessage(hWnd, 0x112, (IntPtr)cmd, IntPtr.Zero);\n    }\n}\n\nprivate void toolStripIcon_MouseDown(object sender, MouseEventArgs e)\n{            \n    toolStripTitle_MouseDown(sender, e);\n}\n</code></pre>\n\n<p>Ещё осталось вернуть возможность таскать окно за заголовок</p>\n\n<pre><code>public partial class Form1 : Form, IMessageFilter\n{\n    private HashSet&lt;Control&gt; controlsToMove = new HashSet&lt;Control&gt;();        \n\n    public Form1()\n    {\n        InitializeComponent();\n        Application.AddMessageFilter(this);\n        controlsToMove.Add(this.toolStripTitle);           \n    }\n\n    public bool PreFilterMessage(ref Message m)\n    {            \n        if (m.Msg == WinApi.WM_LBUTTONDOWN &amp;&amp;\n             controlsToMove.Contains(Control.FromHandle(m.HWnd)))\n        {                \n            WinApi.SendMessage(this.Handle, WinApi.WM_NCLBUTTONDOWN,\n                                (IntPtr)WinApi.HT_CAPTION, (IntPtr)0);                \n        }\n        return false;\n    }\n</code></pre>\n\n<hr>\n\n<p>Некоторые ответы использованные в данном решении:\n<a href=\"https://stackoverflow.com/questions/23966253/moving-form-without-title-bar\">https://stackoverflow.com/questions/23966253/moving-form-without-title-bar</a>\n<a href=\"https://stackoverflow.com/questions/472301/toolstrip-sometimes-not-responding-to-a-mouse-click\">https://stackoverflow.com/questions/472301/toolstrip-sometimes-not-responding-to-a-mouse-click</a>\n<a href=\"https://stackoverflow.com/questions/5245498/application-title-in-taskbar-but-not-titlebar\">https://stackoverflow.com/questions/5245498/application-title-in-taskbar-but-not-titlebar</a>\n<a href=\"https://stackoverflow.com/questions/21825352/how-to-open-window-system-menu-on-right-click\">https://stackoverflow.com/questions/21825352/how-to-open-window-system-menu-on-right-click</a>\n<a href=\"https://stackoverflow.com/questions/16695154/winapi-getsystemmenu-without-ws-sysmenu-in-style\">https://stackoverflow.com/questions/16695154/winapi-getsystemmenu-without-ws-sysmenu-in-style</a></p>\n"}