---
title: "C# и запись в .rtf-шаблон"
se.owner.user_id: 291056
se.owner.display_name: "Aleks Keller"
se.owner.link: "https://ru.stackoverflow.com/users/291056/aleks-keller"
se.link: "https://ru.stackoverflow.com/questions/931706/c-%d0%b8-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d1%8c-%d0%b2-rtf-%d1%88%d0%b0%d0%b1%d0%bb%d0%be%d0%bd"
se.question_id: 931706
se.post_type: question
se.score: 2
---
<p>коллеги.</p>

<p>Есть БД MySQL с русским текстом.
Есть приложение C# WinForms x86 .net 3.5.
Есть файл <code>.rtf</code> с вставками вида #template# и русским текстом.</p>

<p>Задача: записать текст из БД в нужные места в файле.
Читаю через <code>File.ReadAllText</code>, затем склеиваю строки и пишу обратно через <code>File.WriteAllText</code> в новый файл. </p>

<p>И получаю кракозябры вместо вставленного текста. При этом тот текст, что был, остаётся в порядке. </p>

<p>Пробовал читать в одной кодировке, писать в другой... Один пёс. </p>

<p>Может, кто-то сталкивался с этим <code>.rtf</code> - какую комбинацию кодировок посоветуете для базы данных, самого файла, <code>File.ReadAllText</code> и <code>File.WriteAllText</code>? Или может юзать <code>File.Write/ReadAllBytes</code>. Или перекодировать на лету вставляемые куски текста? </p>

<p>Заранее спасибо.</p>

<p>Я до сих пор не въехал, какая родная кодировка у <code>.rtf</code> - 1251 или 1252.</p>

<p>UPD:
Код:</p>

<pre><code>string agreementTemplate = File.ReadAllText("PaymentTemplate.rtf", Encoding.GetEncoding(1251));
agreementTemplate = agreementTemplate.Replace("#klientName#", CurrentCredit.Client);
agreementTemplate = agreementTemplate.Replace("#klientAdr#", CurrentCredit.ClientAdr);
File.WriteAllText("Сведения о платежах для договора №" + CurrentCredit.Number + ".doc", agreementTemplate, Encoding.GetEncoding(1251));
</code></pre>

<p>Результат:
Андрей Семёнов
óë. Ëåíèíà, 24</p>

<p>Добавил новый файл для примера.
При загрузке:
"{\rtf1\ansi\ansicpg1251\deff0{\fonttbl{\f0\fnil\fcharset204 Calibri;}{\f1\fnil\fcharset0 Calibri;}}\r\n\viewkind4\uc1\pard\sa200\sl276\slmult1\lang1049\f0\fs22\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\b\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\ul\b0\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\b\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\ulnone\b0\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2: \lang1033\f1 #replace#\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\par\r\n\par\r\n}\r\n"</p>

<p>После замены replace на русский текст</p>

<p>"{\rtf1\ansi\ansicpg1251\deff0{\fonttbl{\f0\fnil\fcharset204 Calibri;}{\f1\fnil\fcharset0 Calibri;}}\r\n\viewkind4\uc1\pard\sa200\sl276\slmult1\lang1049\f0\fs22\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\b\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\ul\b0\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\b\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\ulnone\b0\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2: \lang1033\f1\'c0\'ed\'e4\'f0\'e5\'e9 \'d1\'e5\'ec\'b8\'ed\'ee\'e2\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\lang1049\f0\'d0\'f3\'f1\'f1\'ea\'e8\'e9 \'f2\'e5\'ea\'f1\'f2\lang1033\f1\par\r\n\par\r\n\par\r\n}\r\n"</p>

<p>Содержимое файла</p>

<p>Русский текст
Русский текст (жирным)
Русский текст (подчёркнутым)
Русский текст (жирным подч)
Русский текст
Русский текст: #replace#
Русский текст
Русский текст</p>

<p>Обновление: решение проблемы, как обычно, с помощью костылей. Вместо шаблона вида "#replace#" делаем шаблон КИРИЛЛИЦЕЙ вида "ИмяКлиента". </p>

<p>То есть текст в шаблоне: "клиент, в лице ИмяКлиента, обязывается..."</p>

<p>Затем, с помощью функции, предложенной nick_n_a, делаем такую кракозябру:</p>

<pre><code>templateStr = loadfile...
templateStr = templateStr.Replace(ToRtf("ИмяКлиента"), ToRtf(CurrentCredit.Name));
</code></pre>

<p>где CurrentCredit.Name - русский текст из БД
На кодировку ложим болт ибо теперь неважно.</p>

<p>В общем, оно работает. Но... сами понимаете. Кто придумает что-то лучше - милости просим)</p>

<p>ЗЫ: правда, на основных файлах ещё не проверял, если что - вернусь)</p>
