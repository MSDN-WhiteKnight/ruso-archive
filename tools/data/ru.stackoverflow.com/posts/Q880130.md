---
title: "Аналог PtrToStructure для классов"
se.owner.user_id: 248572
se.owner.display_name: "Kir_Antipov"
se.owner.link: "https://ru.stackoverflow.com/users/248572/kir-antipov"
se.link: "https://ru.stackoverflow.com/questions/880130/%d0%90%d0%bd%d0%b0%d0%bb%d0%be%d0%b3-ptrtostructure-%d0%b4%d0%bb%d1%8f-%d0%ba%d0%bb%d0%b0%d1%81%d1%81%d0%be%d0%b2"
se.question_id: 880130
se.post_type: question
se.score: 4
---
<p>Товарищи, стал мне интересен следующий вопрос:</p>

<p>Положим, есть у нас примера ради структура <code>System.Drawing.Point</code><br>
Мы спокойно можем баловаться с ней следующим образом:</p>

<pre><code>// Инициализируем нашу структурку
Point point = new Point(2, 3);

// Получаем ее адрес
Point* pointer = &amp;point;

// Получим ее данные
int x = ((int*)pointer)[0]; // 2
int y = ((int*)pointer)[1]; // 3

// Получаем ту же структуру, разыменовав указатель
Point copied = *pointer;

// Или так (получаем нулевую `Point` по указателю)
copied = pointer[0];

// Или даже так
copied = Marshal.PtrToStructure&lt;Point&gt;(new IntPtr(pointer));
</code></pre>

<p>В общем, имея указатель, мы спокойно можем получить <strong>структуру</strong> в явном виде</p>

<hr>

<p>Теперь же отойдем от <em>типов значения</em> и перейдем к типам <em>ссылочным</em>, то есть поговорить я хочу о подобных механизмах для <strong>классов</strong></p>

<p>Оперируя инстансами классов, мы на деле оперируем их ссылками, то есть, получив указатель, мы получим указатель на ссылку на определенный участок памяти, где как раз и можно найти данные объекта</p>

<p>То есть следующий псевдо-код:</p>

<pre><code>// Обозначим instance'ы классов
MyClass my0 = new MyClass { A = 2 };
MyClass my1 = new MyClass { A = 3 };

// Некоторые действия
IntPtr* ptr0 = ...;
IntPtr* ptr1 = ...;

IntPtr tmp = *ptr0;

ptr0[0] = ptr1[0];
ptr1[0] = tmp;

Console.WriteLine(my0.A); // 3
Console.WriteLine(my1.A); // 2
</code></pre>

<p>На деле аналогичен простой смене переменных местами</p>

<hr>

<p>И вот теперь главный вопрос: каким образом, имея указатель, я могу также, как и в случае со структурой, получить объект?</p>

<p>Проблема в том, что </p>

<ul>
<li>Создание указателя на класс - невозможно (ошибка <a href="https://docs.microsoft.com/ru-ru/dotnet/csharp/misc/cs0208" rel="nofollow noreferrer">CS0208</a>)</li>
<li>А <a href="https://msdn.microsoft.com/ru-ru/library/system.runtime.interopservices.marshal.ptrtostructure%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396" rel="nofollow noreferrer">Marshal.PtrToStructure</a> также рассчитан только на структуры</li>
</ul>

<p>То есть я ищу нечто такое:</p>

<pre><code>IntPtr* pointer = ...;
// Я знаю, что это не работает, это просто псевдо-код
MyClass my = *((MyClass*)pointer);
my = Marshal.PtrToClass&lt;MyClass&gt;(new IntPtr(pointer));
</code></pre>

<hr>

<p>Собственно, <strong>возможно ли</strong> такое в <code>C#</code> (не думаю, что прямо совсем никак) и, если да, то <strong>как</strong>?</p>

<p>Приветствуются даже самые безумные идеи!</p>
