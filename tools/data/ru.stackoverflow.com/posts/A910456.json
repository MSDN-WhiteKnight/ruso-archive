{"owner":{"reputation":16137,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":5,"last_activity_date":1542959889,"creation_date":1542959889,"answer_id":910456,"question_id":910336,"body":"<p>Диалог \"Открыть с помощью\" отображает не список всех установленных приложений, он составляет список приложений на основе двух источников:</p>\n\n<ol>\n<li>Приложения, перечисленные в ключе реестра <code>HKEY_CLASSES_ROOT\\Applications</code>, для которых не определен параметр NoOpenWith.</li>\n<li>Приложения, зарегистрированные для конкретного расширения файлов в следующих ключах:</li>\n</ol>\n\n<pre class=\"lang-none prettyprint-override\"><code>HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts\\.(расширение)\\OpenWithProgids\nHKCU\\Software\\Classes\\.(расширение)\\OpenWithProgids\nHKCU\\Software\\Classes\\.(расширение)\\OpenWithList\n</code></pre>\n\n<p>Чтобы перейти от имени exe-файла к его полному пути, нужно найти его в одной из следующих веток:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\\n</code></pre>\n\n<p>Далее, значок приложения и его читаемое описание обычно нигде в реестре явно не прописаны и берутся из ресурсов EXE-файла.</p>\n\n<p>Для получения значка можно использовать функцию <a href=\"https://docs.microsoft.com/en-us/windows/desktop/api/shellapi/nf-shellapi-extracticonw\" rel=\"noreferrer\">ExtractIcon</a></p>\n\n<p>Для получения описания можно использовать функцию <a href=\"https://docs.microsoft.com/en-us/windows/desktop/api/winver/nf-winver-verqueryvaluew\" rel=\"noreferrer\">VerQueryValue</a>, передавая в качестве пути к ресурсу строку вида <code>\\StringFileInfo\\lang-codepage\\FileDescription</code>.</p>\n\n<p>Для примера, вывод списка программ из <code>HKEY_CLASSES_ROOT\\Applications</code>:</p>\n\n<pre><code>#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;windows.h&gt;\n\n#define MAX_KEY_LENGTH 255\n#define MAX_VALUE_NAME 16383\n\nvoid QueryKey(HKEY hKey) \n{ \n    wchar_t    achKey[MAX_KEY_LENGTH];   // buffer for subkey name\n    DWORD    cbName;                   // size of name string \n    wchar_t    achClass[MAX_PATH] = L\"\";  // buffer for class name \n    DWORD    cchClassName = MAX_PATH;  // size of class string \n    DWORD    cSubKeys=0;               // number of subkeys \n    DWORD    cbMaxSubKey;              // longest subkey size \n    DWORD    cchMaxClass;              // longest class string \n    DWORD    cValues;              // number of values for key \n    DWORD    cchMaxValue;          // longest value name \n    DWORD    cbMaxValueData;       // longest value data \n    DWORD    cbSecurityDescriptor; // size of security descriptor \n    FILETIME ftLastWriteTime;      // last write time \n\n    DWORD type;\n    DWORD cdata; \n    HKEY hSubkey;\n    DWORD i, retCode; \n\n    wchar_t  achValue[MAX_VALUE_NAME]; \n    DWORD cchValue = MAX_VALUE_NAME; \n\n    // Get the class name and the value count. \n    retCode = RegQueryInfoKey(\n        hKey,                    // key handle \n        achClass,                // buffer for class name \n        &amp;cchClassName,           // size of class string \n        NULL,                    // reserved \n        &amp;cSubKeys,               // number of subkeys \n        &amp;cbMaxSubKey,            // longest subkey size \n        &amp;cchMaxClass,            // longest class string \n        &amp;cValues,                // number of values for this key \n        &amp;cchMaxValue,            // longest value name \n        &amp;cbMaxValueData,         // longest value data \n        &amp;cbSecurityDescriptor,   // security descriptor \n        &amp;ftLastWriteTime);       // last write time \n\n    // Enumerate the subkeys\n\n    if (cSubKeys == 0) {\n        wprintf(L\"Error: no subkeys!\\n\",achKey);        \n    }\n    else {        \n\n        for (i=0; i&lt;cSubKeys; i++) \n        { \n            cbName = MAX_KEY_LENGTH;\n            retCode = RegEnumKeyEx(hKey, i,\n                     achKey, \n                     &amp;cbName, \n                     NULL, \n                     NULL, \n                     NULL, \n                     &amp;ftLastWriteTime); \n            if (retCode != ERROR_SUCCESS) continue;                           \n\n            retCode =   RegOpenKey(hKey,achKey,&amp;hSubkey);\n\n            if(retCode != ERROR_SUCCESS){\n                    wprintf(L\"%s: RegOpenKey failed\\n\",achKey);\n                    continue;\n            }\n\n            retCode = RegQueryValueEx(hSubkey,L\"NoOpenWith\",NULL,&amp;type,NULL,&amp;cdata);\n            if(retCode == ERROR_FILE_NOT_FOUND){                    \n                    wprintf(TEXT(\"%s\\n\"), achKey);\n            }\n            RegCloseKey(hSubkey);            \n        }\n    }     \n}\n\nint main(int argc, char **argv)\n{\n\n    HKEY hTestKey;\n\n   if( RegOpenKeyEx( HKEY_CLASSES_ROOT,\n        L\"Applications\",\n        0,\n        KEY_READ,\n        &amp;hTestKey) == ERROR_SUCCESS\n      )\n   {\n      QueryKey(hTestKey);\n   }\n\n   RegCloseKey(hTestKey);\n\n    getchar();\n    return 0;\n}\n</code></pre>\n\n<p>Источники:</p>\n\n<p><a href=\"https://docs.microsoft.com/en-us/windows/desktop/shell/app-registration#using-the-applications-subkey\" rel=\"noreferrer\">Application registration</a></p>\n\n<p><a href=\"https://docs.microsoft.com/en-us/windows/desktop/sysinfo/enumerating-registry-subkeys\" rel=\"noreferrer\">Enumerating registry subkeys</a></p>\n\n<p><a href=\"https://docs.microsoft.com/en-us/windows/desktop/shell/how-to-exclude-an-application-from-the-open-with-dialog-box-for-unassociated-file-types\" rel=\"noreferrer\">How to Exclude an Application from the Open With Dialog Box for Unassociated File Types</a></p>\n"}