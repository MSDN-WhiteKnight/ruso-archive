---
title: "Как создать DynamicMethod из IL-кода?"
se.owner.user_id: 343969
se.owner.display_name: "Antinet"
se.owner.link: "https://ru.stackoverflow.com/users/343969/antinet"
se.link: "https://ru.stackoverflow.com/questions/1006349/%d0%9a%d0%b0%d0%ba-%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d1%82%d1%8c-dynamicmethod-%d0%b8%d0%b7-il-%d0%ba%d0%be%d0%b4%d0%b0"
se.question_id: 1006349
se.post_type: question
se.score: 0
---
<p>мне необходимо создать DynamicMethod по IL-коду следующего метода:</p>

<pre><code>public int test(string v1, int v2)
{
    return (int)call(new object[]{ v1, v2 });
}
</code></pre>

<p>где </p>

<pre><code>public object call(object[] args)
{
    // что-то возвращающее int
}
</code></pre>

<p>Я переписал код из ildasm в ILGenerator.Emit, но при выполнении сгенерированного делегата появляется ошибка недопустимого кода MSIL. Помогите, пожалуйста, создать корректные вызовы ILGenerator.Emit для генерации метода, либо пришлите ссылки на литературу по этому. Заранее благодарю!</p>

<pre><code>Type[] arg_types = new Type[] { typeof(string), typeof(int) };
            var dn = new DynamicMethod("myMethod", typeof(int), arg_types);
            var il = dn.GetILGenerator();
            il.Emit(OpCodes.Nop);
            il.Emit(OpCodes.Ldarg_0);
            il.Emit(OpCodes.Ldc_I4_2);
            il.Emit(OpCodes.Newarr, typeof(object));
            il.Emit(OpCodes.Dup);
            il.Emit(OpCodes.Ldc_I4_0);
            il.Emit(OpCodes.Ldarg_1);
            il.Emit(OpCodes.Stelem_Ref);
            il.Emit(OpCodes.Dup);
            il.Emit(OpCodes.Ldc_I4_1);
            il.Emit(OpCodes.Ldarg_2);
            il.Emit(OpCodes.Box, typeof(int));
            il.Emit(OpCodes.Stelem_Ref);
            il.Emit(OpCodes.Call, typeof(Form1).GetMethod("call"));
            il.Emit(OpCodes.Unbox_Any, typeof(int));
            il.Emit(OpCodes.Stloc_0);
            il.Emit(OpCodes.Br_S);
            il.Emit(OpCodes.Ldloc_0);
            il.Emit(OpCodes.Ret);
            var del = dn.CreateDelegate(typeof(Func&lt;string, int, int&gt;));
            del.DynamicInvoke("test",77);
</code></pre>
