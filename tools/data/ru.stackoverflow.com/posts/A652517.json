{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":true,"score":2,"last_activity_date":1491930490,"creation_date":1491930490,"answer_id":652517,"question_id":650094,"body":"<p>Windows на ура рассылает всем окнам верхнего уровня сообщения об изменении состоянии устройств. Успевайте только ловить (ну и отфильтровывать лишнее). Вас интересует сообщение <em><a href=\"https://msdn.microsoft.com/en-us/library/aa363480(v=vs.85).aspx\" rel=\"nofollow noreferrer\">WM_DEVICECHANGE</a></em> с событиями <em>DBT_DEVICEARRIVAL</em> и <em>DBT_DEVICEREMOVECOMPLETE</em>, возникающее для типа устройств DBT_DEVTYPE_VOLUME. </p>\n\n<p>Добавьте следующий код в любое окно верхнего уровня (не имеющее родителя):</p>\n\n<pre><code>using System;\nusing System.Collections.Generic;\nusing System.Text;\nusing System.Windows.Forms;\nusing System.Runtime.InteropServices;\nusing System.IO;\n\nnamespace DeviceTest\n{\n    public partial class Form1 : Form\n    {\n        /*WINAPI constants*/\n        const int WM_DEVICECHANGE = 0x219;\n        const int DBT_DEVICEARRIVAL = 0x8000;\n        const int DBT_DEVICEREMOVECOMPLETE = 0x8004;\n        const int DBT_DEVTYP_VOLUME = 0x00000002;\n\n        public Form1()\n        {\n            InitializeComponent();\n            PrintDrives();\n        }\n\n        /// &lt;summary&gt;\n        /// Вывести список дисков в textbox\n        /// &lt;/summary&gt;\n        public void PrintDrives()\n        {\n            DriveInfo[] allDrives = DriveInfo.GetDrives();\n            StringBuilder sb = new StringBuilder(255);\n\n            foreach (DriveInfo d in allDrives)\n            {\n                sb.Append(d.Name);//это буква диска\n                sb.Append(\" (\"+ d.DriveType.ToString()+\")\");\n                if (d.IsReady == true)\n                {\n                    sb.Append(\" - \"+ d.VolumeLabel);//метка диска\n                    sb.Append(\", \"+ d.DriveFormat);//файловая система\n                }\n                else sb.Append(\" [not ready]\");\n                sb.AppendLine();\n            }\n            tbDrives.Text = sb.ToString();\n\n        }\n\n        protected override void WndProc(ref Message m)\n        {\n            DEV_BROADCAST_HDR pHdr;\n            switch (m.Msg)\n            {\n                case WM_DEVICECHANGE: \n                    switch ((int)m.WParam)\n                    {\n                        case DBT_DEVICEARRIVAL://устройство подключено\n\n                            pHdr = (DEV_BROADCAST_HDR)Marshal.PtrToStructure(m.LParam, typeof(DEV_BROADCAST_HDR));\n                            if (pHdr.dbch_devicetype == DBT_DEVTYP_VOLUME)\n                            {\n                                tbLog.Text+=Environment.NewLine+DateTime.Now.ToString()+\" :\"+\"Volume was inserted\";\n                                PrintDrives();\n                            }\n\n                        break;\n\n                        case DBT_DEVICEREMOVECOMPLETE://устройство отключено\n\n                        pHdr = (DEV_BROADCAST_HDR)Marshal.PtrToStructure(m.LParam, typeof(DEV_BROADCAST_HDR));\n                        if (pHdr.dbch_devicetype == DBT_DEVTYP_VOLUME)\n                        {\n                            tbLog.Text += Environment.NewLine + DateTime.Now.ToString() + \" :\" + \"Volume was removed\";\n                            PrintDrives();\n                        }\n\n                        break;\n                    }\n                    break;\n            }\n\n            base.WndProc(ref m);            \n        }   \n\n    }\n\n    public struct DEV_BROADCAST_HDR\n    {\n        public int dbch_size;\n        public int dbch_devicetype;\n        public int dbch_reserved;\n    }\n\n\n}\n</code></pre>\n\n<p>Только учтите, что в код обработки данных сообщений нельзя вписывать длительные операции, так как система ждет их обработки всеми окнами и соответственно это может привести к подвисанию системы.</p>\n"}