---
title: "Answer 811638"
se.owner.user_id: 281694
se.owner.display_name: "MindCleaner"
se.owner.link: "https://ru.stackoverflow.com/users/281694/mindcleaner"
se.answer_id: 811638
se.question_id: 805934
se.post_type: answer
se.score: 1
se.is_accepted: False
---
<p>Обратите внимание на строки:</p>

<pre><code> WordTableAnalyser wta = new WordTableAnalyser(table,1.0);
 MyWordCell c = wta.getCell(8, 1);
 MessageBox.Show(c.rows.ToString() + ";" + c.columns.ToString());
</code></pre>

<p>Исходная таблица</p>

<p><a href="https://i.stack.imgur.com/UqNgS.png" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/UqNgS.png" alt="введите сюда описание изображения"></a></p>

<p>Приложение на основе Windows Forms</p>

<pre><code>using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using Microsoft.Office.Interop.Word;
using System.Reflection;

namespace WorkWithWord
{
    using Word = Microsoft.Office.Interop.Word;
    public class MyWordCell
    {
        public double x = 0;
        public double x2 = 0;
        public double w = 0;
        public int columns = 1;
        public int rows = 1;
        public int ini_row=-1;
        public int ini_column=-1;
        public Word.Cell wc;
        public MyWordCell(Word.Cell cell)
        {
            wc = cell;
        }
    }
    public class DoubleToleranceComparer : IComparer&lt;double&gt;,IEqualityComparer&lt;double&gt;
    {
        double tolerance=0;
        public DoubleToleranceComparer(double tolerance)
        {
            this.tolerance = tolerance;
        }
        #region Члены IComparer&lt;double&gt;

        public int Compare(double x, double y)
        {
            double delta = x - y;
            return Math.Abs(delta) &lt;= tolerance ? 0 : Math.Sign(delta);
        }

        #endregion

        #region Члены IEqualityComparer&lt;double&gt;

        public bool Equals(double x, double y)
        {
            throw new NotImplementedException();
        }

        public int GetHashCode(double obj)
        {
            throw new NotImplementedException();
        }

        #endregion
    }
    public class WordTableAnalyser
    {


        public static Object missingObj = System.Reflection.Missing.Value;
        public static Object trueObj = true;
        public static Object falseObj = false;

        Word.Table wtable = null;
        double cc = 0;//количество необъединенных столбцов
        double rc = 0;//количество необъединенных строк
        double WT = 0;//ширина таблицы
        double HT = 0;//высота таблицы

        DoubleToleranceComparer dt_comparer;//сравниватель double c допуском

        SortedList&lt;double,double&gt; split_xs;//встречающиеся  координаты границ ячеек таблицы по x



        List&lt;MyWordCell&gt; curRow = new List&lt;MyWordCell&gt;();
        List&lt;List&lt;MyWordCell&gt;&gt; myTable = new List&lt;List&lt;MyWordCell&gt;&gt;();


        public MyWordCell getCell(int ini_row,int ini_column)
        {
            MyWordCell c = null;


            for (int ci = 0; ci &lt; myTable[ini_row-1].Count; ++ci)
                {
                    if (myTable[ini_row - 1][ci].ini_column == ini_column)
                    {
                        c = myTable[ini_row - 1][ci];
                        break;
                    }
                }


                return c;
        }

        public WordTableAnalyser(Word.Table table,double tolerance)
        {
            wtable = table;
            cc = table.Columns.Count;
            rc = table.Rows.Count;
            dt_comparer = new DoubleToleranceComparer(tolerance);
            split_xs = new SortedList&lt;double,double&gt;(dt_comparer);
            split_xs.Add(0.0, 0.0);
            for (int i = 1; i &lt;= cc; ++i)
            {
                try
                {
                    Word.Cell cell=table.Cell(1,i);
                    MyWordCell myCell = new MyWordCell(cell);
                    myCell.x = WT;
                    myCell.w = cell.PreferredWidth;
                    myCell.x2 = myCell.x + myCell.w;
                    myCell.ini_row = 1;
                    myCell.ini_column = i;
                    curRow.Add(myCell);
                    WT += cell.PreferredWidth;//Width не всегда определена

                    //cell.
                    split_xs.Add(WT, WT);
                }
                catch(Exception ex)
                { 

                }
            }
            myTable.Add(curRow);

            for(int j=2;j&lt;=rc;++j)
            {
                List&lt;MyWordCell&gt; prevRow = curRow;
                curRow = new List&lt;MyWordCell&gt;();
                List&lt;MyWordCell&gt; myTableRow = new List&lt;MyWordCell&gt;();
                int prevColInd = 0;
                double curX=0;
                for (int i = 1; i &lt;= cc; ++i)
                {
                    try
                    {
                        Word.Cell cell=table.Cell(j,i);
                        MyWordCell myCell = new MyWordCell(cell);
                        myCell.x = curX;
                        myCell.w = cell.PreferredWidth;
                        myCell.x2 = myCell.x + myCell.w;
                        myCell.ini_row = j;
                        myCell.ini_column = i;
                        curRow.Add(myCell);
                        //while(myTable.Count&lt;myCell.in)
                        myTableRow.Add(myCell);
                        //cell.
                        try
                        {
                            split_xs.Add(myCell.x2, myCell.x2);
                        }
                        catch (Exception ex) { }
                        curX = myCell.x2;
                        if (dt_comparer.Compare(myCell.x, prevRow[prevColInd].x) == 0)
                        {
                            while ((prevColInd&lt;prevRow.Count) &amp;&amp; (dt_comparer.Compare(prevRow[prevColInd].x, myCell.x2) &lt; 0))
                            prevColInd++;
                        }
                    }
                    catch(Exception ex)//для текущего ряда по данному индексу пропуск
                    {
                        if (prevColInd &lt; prevRow.Count)
                        {
                            prevRow[prevColInd].rows++;
                            curRow.Add(prevRow[prevColInd]);
                            curX = prevRow[prevColInd].x2;
                            prevColInd++;
                           }
                        else
                        {
                            break;
                        }
                    }
                }
                myTable.Add(myTableRow);
            }

            //добавляем недостающие колонки
            for (int j = 0; j &lt; myTable.Count; ++j)
            {
                for (int i = 0; i &lt; myTable[j].Count; ++i)
                {
                    MyWordCell c = myTable[j][i];
                    double x = c.x;
                    double x2 = c.x2;
                    int ind_x=split_xs.IndexOfKey(x);
                    int ind_x2 = split_xs.IndexOfKey(x2);
                    int delta_ind=ind_x2 - ind_x;
                    if (delta_ind &gt; 1) c.columns += delta_ind - 1; 
                }
            }


        }
    }
    public partial class Form1 : Form
    {
        public static Object missingObj = System.Reflection.Missing.Value;
        public static Object trueObj = true;
        public static Object falseObj = false;
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {

        }

        private void buttonTest_Click(object sender, EventArgs e)
        {
            Word._Application application;
            Word._Document document=null;

            //создаем обьект приложения word
            application = new Word.Application();
            // создаем путь к файлу
            Object templatePathObj = @"D:\Work\Life\StackOverflow\Разбиение объединённых ячеек в таблице.docm"; ;

            // если вылетим не этом этапе, приложение останется открытым
            try
            {
                document = application.Documents.Add(ref  templatePathObj, ref missingObj, ref missingObj, ref missingObj);

                Word.Table table = document.Tables[1];//в файле примера одна единственная таблица
                int rcount = table.Rows.Count;
                int ccount = table.Columns.Count;


                WordTableAnalyser wta = new WordTableAnalyser(table,1.0);
                MyWordCell c = wta.getCell(8, 1);
                MessageBox.Show(c.rows.ToString() + ";" + c.columns.ToString());

                application.Visible = true;
            }
            catch (Exception error)
            {
                if(document!=null)document.Close(ref falseObj, ref  missingObj, ref missingObj);
                application.Quit(ref missingObj, ref  missingObj, ref missingObj);
                document = null;
                application = null;
                MessageBox.Show(error.Message, "", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

        }
    }
}
</code></pre>
