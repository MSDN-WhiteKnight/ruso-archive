---
title: "Answer 801624"
se.owner.user_id: 10105
se.owner.display_name: "VladD"
se.owner.link: "https://ru.stackoverflow.com/users/10105/vladd"
se.answer_id: 801624
se.question_id: 801587
se.post_type: answer
se.score: 2
se.is_accepted: False
---
<p>Ну например, для структур, состоящих только из примитивных полей, подойдёт такой хелпер:</p>

<pre><code>static void FillFromStream&lt;T&gt;(ref T t, Stream stream) where T : struct
{
    object boxed = t;
    using (var br = new BinaryReader(stream, Encoding.ASCII, leaveOpen: true))
    {
        var fields = typeof(T).GetFields().OrderBy(f =&gt; f.MetadataToken);
        foreach (var field in fields)
        {
            if (!field.FieldType.IsPrimitive)
                throw new NotImplementedException("nested compound types");
            // for primitive types:
            if (!primitiveExtractors.TryGetValue(field.FieldType, out var extractor))
                throw new NotImplementedException("unsupported primitive type");
            var value = extractor(br);
            field.SetValue(boxed, value);
        }
    }
    t = (T)boxed;
}
</code></pre>

<p>Вспомогательная таблица:</p>

<pre><code>static Dictionary&lt;Type, Func&lt;BinaryReader, object&gt;&gt; primitiveExtractors =
    new Dictionary&lt;Type, Func&lt;BinaryReader, object&gt;&gt;()
    {
        [typeof(sbyte)]  = br =&gt; br.ReadSByte(),
        [typeof(byte)]   = br =&gt; br.ReadByte(),
        [typeof(short)]  = br =&gt; br.ReadInt16(),
        [typeof(ushort)] = br =&gt; br.ReadUInt16(),
        [typeof(int)]    = br =&gt; br.ReadInt32(),
        [typeof(uint)]   = br =&gt; br.ReadUInt32(),
        [typeof(long)]   = br =&gt; br.ReadInt64(),
        [typeof(ulong)]  = br =&gt; br.ReadUInt64(),
        [typeof(float)]  = br =&gt; br.ReadSingle(),
        [typeof(double)] = br =&gt; br.ReadDouble()
    };
</code></pre>

<p>Как вы видите, без <code>unsafe</code> и прочих небезопасных методов можно обойтись.</p>

<p>Не забудьте открыть доступ у полям.</p>

<hr>

<p><code>.OrderBy(f =&gt; f.MetadataToken)</code> нужно для того, чтобы порядок полей <a href="https://stackoverflow.com/a/11403362/276994">соответствовал текстуальному порядку</a>.</p>
