---
title: "Указатель на тело функции?"
se.owner.user_id: 271366
se.owner.display_name: "digital-mag"
se.owner.link: "https://ru.stackoverflow.com/users/271366/digital-mag"
se.link: "https://ru.stackoverflow.com/questions/1005297/%d0%a3%d0%ba%d0%b0%d0%b7%d0%b0%d1%82%d0%b5%d0%bb%d1%8c-%d0%bd%d0%b0-%d1%82%d0%b5%d0%bb%d0%be-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8"
se.question_id: 1005297
se.post_type: question
se.score: 2
---
<p>Столкнулся я с проблемой изменения кода функции в целях оптимизации (прошу прощения за си-стиль): </p>

<pre><code>    static inline bool ECX_to_EBX(void *ptr) {

        map&lt;byte*, byte&gt; ecxs;
        ecxs[(((byte*)ptr) + 18)] = 0xBB;
        ecxs[(((byte*)ptr) + 67)] = 0x5D;
        ecxs[(((byte*)ptr) + 69)] = 0x53;

        size_t wr;
        for (map&lt;byte*, byte&gt;::iterator pair_item = ecxs.begin(); pair_item != ecxs.end(); ++pair_item)
        {
            WriteProcessMemory(GetCurrentProcess(), pair_item-&gt;first, &amp;pair_item-&gt;second, sizeof(byte), (SIZE_T*)&amp;wr);          

            if (wr == 0) return true;
#ifdef LOG
            else MessageBoxA(0, "", "replaced", 0);
#endif
        }

        return 0;
    }
</code></pre>

<p>где в <code>ptr</code> ожидается указатель на конкретную функцию, которую я уже разобрал на ассемблерные составляющие и хочу немного подкорректировать (заменить регистр ECX на EBX). Эта конкретная функция выглядит так: </p>

<pre><code>struct MyClass{
    static void MyFunc();
}
</code></pre>

<p>Передаю ее в качестве аргумента:</p>

<pre><code>Utils::ECX_to_EBX(MyClass::MyFunc);
</code></pre>

<p>Смотрю в памяти, а там не то. Оказывается, что MyClass::MyFunc дает указатель на <code>jmp MyProgram.MyClass::MyFunc</code> вместо указателя на само тело функции. Собственно вопрос, как получить указатель на первый байт тела (без вычисления относительного адреса относительно jmp) и почему я получаю указатель на jmp вместо него? </p>

<p>Это особенность компилятора visual-c++ или какие-то ключи компиляции?</p>

<p>На MinGW я такого казуса не припомню</p>
