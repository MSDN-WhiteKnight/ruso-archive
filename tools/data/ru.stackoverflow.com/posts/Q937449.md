---
title: "Вывод путей нескольких выделенных файлов в проводнике через программу C#"
se.owner.user_id: 309995
se.owner.display_name: "Павел Ериков"
se.owner.link: "https://ru.stackoverflow.com/users/309995/%d0%9f%d0%b0%d0%b2%d0%b5%d0%bb-%d0%95%d1%80%d0%b8%d0%ba%d0%be%d0%b2"
se.link: "https://ru.stackoverflow.com/questions/937449/%d0%92%d1%8b%d0%b2%d0%be%d0%b4-%d0%bf%d1%83%d1%82%d0%b5%d0%b9-%d0%bd%d0%b5%d1%81%d0%ba%d0%be%d0%bb%d1%8c%d0%ba%d0%b8%d1%85-%d0%b2%d1%8b%d0%b4%d0%b5%d0%bb%d0%b5%d0%bd%d0%bd%d1%8b%d1%85-%d1%84%d0%b0%d0%b9%d0%bb%d0%be%d0%b2-%d0%b2-%d0%bf%d1%80%d0%be%d0%b2%d0%be%d0%b4%d0%bd%d0%b8%d0%ba%d0%b5-%d1%87%d0%b5%d1%80%d0%b5%d0%b7-%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%d1%83-c"
se.question_id: 937449
se.post_type: question
se.score: 1
---
<p>Я бы хотел, чтобы когда ты выделяешь несколько например фотографий в проводнике и нажимаешь "Открыть", то открывалась бы программа, в которой можно было бы работать с информацией об этих файлах.</p>

<p>Пытался уже реализовать такое, но выделив несколько файлов открывалось несколько окон программы.</p>

<p>Сделал небольшую доработку </p>

<p>App.xaml.cs</p>

<pre><code>[DllImport("user32.dll")]
public static extern IntPtr SendMessage(IntPtr hWnd, uint Msg, IntPtr wParam, ref COPYDATASTRUCT lParam);

[StructLayout(LayoutKind.Sequential)]
public struct COPYDATASTRUCT
{
    public IntPtr dwData;
    public int cbData;
    public IntPtr lpData;
}
public const uint WM_COPYDATA = 0x004A;

protected override void OnStartup(StartupEventArgs e)
{
    base.OnStartup(e);
    Process this_process = Process.GetCurrentProcess();

    Process[] other_processes =
    Process.GetProcessesByName(this_process.ProcessName).Where(pr =&gt; pr.Id != this_process.Id).ToArray();

    foreach (var pr in other_processes)
    {
         pr.WaitForInputIdle(1000);
         IntPtr hWnd = pr.MainWindowHandle;
         if (hWnd == IntPtr.Zero) continue;
         string command = e.Args[0] + " " + e.Args.Length;
         var cds = new COPYDATASTRUCT();
         cds.dwData = (IntPtr)1;
         cds.cbData = (command.Length + 1) * 2;
         cds.lpData = Marshal.StringToHGlobalUni(command);
         SendMessage(hWnd, WM_COPYDATA, IntPtr.Zero, ref cds);
         Marshal.FreeHGlobal(cds.lpData);
         Environment.Exit(0);
    }
}    
</code></pre>

<p>И MainWindow.xaml.cs</p>

<pre><code>private IntPtr WndProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
{
     if (msg == WM_COPYDATA)
     {
         COPYDATASTRUCT data = new COPYDATASTRUCT();
         data = (COPYDATASTRUCT)Marshal.PtrToStructure(lParam, data.GetType());
         MessageBox.Show("Received command: " + Marshal.PtrToStringUni(data.lpData));
     }

     return IntPtr.Zero;
}
private void Window_Loaded(object sender, RoutedEventArgs e)
{
     WindowInteropHelper h = new WindowInteropHelper(this);
     HwndSource source = HwndSource.FromHwnd(h.Handle);
     source.AddHook(new HwndSourceHook(WndProc));//регистрируем обработчик сообщений      
}
</code></pre>

<p>И все хорошо в принципе, т.к. когда я кликаю по картинке (при открытом окне программы) то выводится в MessageBox.Show ее путь. Но проблема теперь в том, что если я выберу несколько картинок и нажму открыть то раньше бы открылось столько экземпляров сколько картинок. А сейчас MessageBox.Show выведет только путь той картинки которая была выбрана первой.</p>
