---
title: "Answer 1034402"
se.owner.user_id: 22836
se.owner.display_name: "4per"
se.owner.link: "https://ru.stackoverflow.com/users/22836/4per"
se.answer_id: 1034402
se.question_id: 1030195
se.post_type: answer
se.score: 9
se.is_accepted: True
---
<p>Нарисуем форму, бросим панель <code>Dock = Top</code>. На неё два ToolStripEx.</p>

<pre><code>/// &lt;summary&gt;
/// Вылечена часть глюков ToolStrip с фокусом
/// &lt;/summary&gt;
public class ToolStripEx : ToolStrip
{
    protected override void WndProc(ref Message m)
    {
        base.WndProc(ref m);

        if (m.Msg == WinApi.WM_MOUSEACTIVATE &amp;&amp;
            m.Result == (IntPtr)WinApi.MA_ACTIVATEANDEAT)
        {
            m.Result = (IntPtr)WinApi.MA_ACTIVATE;
        }            
    }
}
</code></pre>

<p>Настройка свойств: </p>

<p>левое <code>GripStyle = Hidden, RenderMode = System, Dock = Fill</code></p>

<p>правое <code>GripStyle = Hidden, RenderMode = System, Dock = Fill, LayoutStyle = Flow</code></p>

<p>На левом разместим:</p>

<ul>
<li>кнопку имитирующую системное меню окна,</li>
<li>кнопки самого меню, которое нас интересовало,</li>
<li>ToolStripLabel, который будет играть роль заголовка окна</li>
</ul>

<p>На правом кидаем кнопки, которые будут имитировать штатный ControlBox.
Получилось вот так.</p>

<p><a href="https://i.stack.imgur.com/yo2HB.png" rel="noreferrer"><img src="https://i.stack.imgur.com/yo2HB.png" alt="скриншот формы приложения в дизайн-тайм"></a>
<a href="https://i.stack.imgur.com/LeRip.png" rel="noreferrer"><img src="https://i.stack.imgur.com/LeRip.png" alt="скриншот &quot;Структуры документа&quot; для формы"></a></p>

<p>Теперь собственно нужно убрать заголовок, а имитатору обеспечить схожее поведение.</p>

<p>Самое простое -- это нажатия ControlBox и двойной клик по "заголовку-имитатору".</p>

<pre><code>private void toolStripTitle_DoubleClick(object sender, EventArgs e)
{
    WindowState = WindowState == FormWindowState.Maximized ?
                   FormWindowState.Normal
                   : FormWindowState.Maximized;
    UpdateControlBox();
}

private void toolStripButtonClose_Click(object sender, EventArgs e)
{
    Close();
}

private void toolStripButtonMaximize_Click(object sender, EventArgs e)
{
    WindowState = FormWindowState.Maximized;
    UpdateControlBox();
}

private void toolStripButtonMinimize_Click(object sender, EventArgs e)
{
    this.WindowState = FormWindowState.Minimized;
}

private void toolStripButtonRestore_Click(object sender, EventArgs e)
{
    WindowState = FormWindowState.Normal;
    UpdateControlBox();
}
private void UpdateControlBox()
{
    toolStripButtonMaximize.Visible = WindowState != FormWindowState.Maximized;
    toolStripButtonRestore.Visible = WindowState != FormWindowState.Normal;
}       
</code></pre>

<p>Для того, чтобы скрыть родной заголовок, есть три или четыре способа. Но все, кроме одного, страдают недостатками: мы теряем возможность отображать текст в TaskBar, или теряем возможность вызывать "системное меню окна".</p>

<p>Мой способ основан на следующем: в дизайнере мы сохраняем стандартный вид окна, затем в обработчике Form.Load захватываем Handle "системное меню окна", и только потом с помощью <code>SetWindowLongPtr</code> ликвидируем штатный заголовок.</p>

<pre><code>private IntPtr sysMenuHandle;
private void Form1_Load(object sender, EventArgs e)
{
    //Захватываем меню
    sysMenuHandle = WinApi.GetSystemMenu(this.Handle, false);

    //Ликвидируем штатный заголовок
    int style = WinApi.GetWindowLongPtr(this.Handle, WinApi.GWL_STYLE).ToInt32();
    WinApi.SetWindowLongPtr(new HandleRef(this, this.Handle), WinApi.GWL_STYLE,
        (IntPtr)(style &amp; ~WinApi.WS_CAPTION));

    //Сворачиваем окно и возвращаем как-было
    //Это костыль, чтобы нормально перерисовалось окно после предыдущей операции
    //Не помешало бы найти менее корявый способ
    var winstate = this.WindowState; 
    this.WindowState = FormWindowState.Minimized;
    this.WindowState = winstate;

    //Обновляем внешний вид ControlBox
    UpdateControlBox();            
}
</code></pre>

<p>Теперь мы сможем вызывать "системное меню окна"   </p>

<pre><code>private void toolStripTitle_MouseDown(object sender, MouseEventArgs e)
{
    if (e.Button == MouseButtons.Right)
    {
        IntPtr hWnd = this.Handle;
        WinApi.GetWindowRect(hWnd, out WinApi.RECT pos);                
        int cmd = WinApi.TrackPopupMenu(sysMenuHandle, 0x100,  
            this.Left + e.X, this.Top + e.Y, 0, hWnd, IntPtr.Zero);
        if (cmd &gt; 0) WinApi.SendMessage(hWnd, 0x112, (IntPtr)cmd, IntPtr.Zero);
    }
}

private void toolStripIcon_MouseDown(object sender, MouseEventArgs e)
{            
    toolStripTitle_MouseDown(sender, e);
}
</code></pre>

<p>Ещё осталось вернуть возможность таскать окно за заголовок</p>

<pre><code>public partial class Form1 : Form, IMessageFilter
{
    private HashSet&lt;Control&gt; controlsToMove = new HashSet&lt;Control&gt;();        

    public Form1()
    {
        InitializeComponent();
        Application.AddMessageFilter(this);
        controlsToMove.Add(this.toolStripTitle);           
    }

    public bool PreFilterMessage(ref Message m)
    {            
        if (m.Msg == WinApi.WM_LBUTTONDOWN &amp;&amp;
             controlsToMove.Contains(Control.FromHandle(m.HWnd)))
        {                
            WinApi.SendMessage(this.Handle, WinApi.WM_NCLBUTTONDOWN,
                                (IntPtr)WinApi.HT_CAPTION, (IntPtr)0);                
        }
        return false;
    }
</code></pre>

<hr>

<p>Некоторые ответы использованные в данном решении:
<a href="https://stackoverflow.com/questions/23966253/moving-form-without-title-bar">https://stackoverflow.com/questions/23966253/moving-form-without-title-bar</a>
<a href="https://stackoverflow.com/questions/472301/toolstrip-sometimes-not-responding-to-a-mouse-click">https://stackoverflow.com/questions/472301/toolstrip-sometimes-not-responding-to-a-mouse-click</a>
<a href="https://stackoverflow.com/questions/5245498/application-title-in-taskbar-but-not-titlebar">https://stackoverflow.com/questions/5245498/application-title-in-taskbar-but-not-titlebar</a>
<a href="https://stackoverflow.com/questions/21825352/how-to-open-window-system-menu-on-right-click">https://stackoverflow.com/questions/21825352/how-to-open-window-system-menu-on-right-click</a>
<a href="https://stackoverflow.com/questions/16695154/winapi-getsystemmenu-without-ws-sysmenu-in-style">https://stackoverflow.com/questions/16695154/winapi-getsystemmenu-without-ws-sysmenu-in-style</a></p>
