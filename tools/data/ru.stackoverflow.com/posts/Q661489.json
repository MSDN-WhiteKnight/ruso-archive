{"tags":["c++","windows","аудио","mmdevice"],"owner":{"reputation":41,"user_id":248508,"user_type":"registered","profile_image":"https://www.gravatar.com/avatar/0740b6a9788eea3143f263f881491194?s=128&d=identicon&r=PG&f=1","display_name":"Dmitry","link":"https://ru.stackoverflow.com/users/248508/dmitry"},"is_answered":true,"view_count":283,"answer_count":1,"score":4,"last_activity_date":1552140080,"creation_date":1493815679,"last_edit_date":1510506914,"question_id":661489,"link":"https://ru.stackoverflow.com/questions/661489/%d0%9d%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82%d0%b0-%d0%b0%d1%83%d0%b4%d0%b8%d0%be%d1%83%d1%81%d1%82%d1%80%d0%be%d0%b9%d1%81%d1%82%d0%b2%d0%b0-%d0%b2-windows","title":"Настройка формата аудиоустройства в Windows","body":"<p>Я разрабатываю приложение для аудиоустройства, работающего по стандарту usb audio. Одной из задач является выбор формата воспроизведения: количество бит, частота дискретизации. Для задания формата, используя Windows Core Audio API, я написал следующий c++ код:</p>\n\n<pre><code>bool CPropPage::SetMode(int freq, int bits)\n{\n    static const int channels = 2;\n    PROPVARIANT varName;\n    IMMDevice* pDev = NULL;\n    IPropertyStore *pProps = NULL;\n    bool result = false;\n\n    if (!m_pEnumerator)\n        return false;\n\n    HRESULT hr = m_pEnumerator-&gt;GetDevice(m_devguid.c_str(), &amp;pDev);\n    if (hr != S_OK)\n        return false;\n\n    hr = pDev-&gt;OpenPropertyStore(STGM_WRITE, &amp;pProps);\n    if (hr != S_OK)\n        goto exit;\n\n    PropVariantInit(&amp;varName);\n    varName.vt = VT_BLOB;\n    varName.blob.cbSize = sizeof(WAVEFORMATEXTENSIBLE);\n    int alignment = channels * bits / 8;\n    WAVEFORMATEXTENSIBLE format = {\n        {\n            WAVE_FORMAT_EXTENSIBLE,\n            channels,\n            freq,\n            freq * alignment,\n            alignment,\n            bits,\n            (sizeof(WAVEFORMATEXTENSIBLE) - sizeof(WAVEFORMATEX))\n        },\n        {bits},\n        SPEAKER_FRONT_LEFT | SPEAKER_FRONT_RIGHT,\n        KSDATAFORMAT_SUBTYPE_PCM\n    };\n    varName.blob.pBlobData = (BYTE*)&amp;format;\n\n    LogEntry(\"SetMode:%d %d\\n\", freq, bits);\n    hr = pProps-&gt;SetValue(\n        PKEY_AudioEngine_DeviceFormat, varName);\n    if (hr != S_OK)\n        goto exit;\n    LogEntry(\"SetMode ok\\n\");\n\n    LogAudioEngineFormat(pDev, &amp;format.Format);\n\n    result = true;\n\nexit:\n    if (pDev) pDev-&gt;Release();\n    if (pProps) pProps-&gt;Release();\n    return result;\n}\n</code></pre>\n\n<p>По сути, работа функции сводится к заданию свойства <code>PKEY_AudioEngine_DeviceFormat</code> объекта <code>IMMDevice</code>.</p>\n\n<p>Примечание. <code>m_pEnumerator</code> - указатель на объект COM-класса <code>IMMDeviceEnumerator</code>. <code>m_devguid</code> - GUID устройства.</p>\n\n<p>Результат работы функции: формат задается, и это видно в Панель управления -> Звук -> Свойства. Однако при этом невозможно воспроизвести ни один звук. Windows Media Player сообщает, что данный формат не поддерживается. (Задаваемый формат: 44100 Гц, 2 канала, 16 бит).\nПри этом, если тот же самый формат задать через Панель управления -> Звук -> Свойства, все звуки, аудиофайлы воспроизводятся успешно.</p>\n\n<p>Что я делаю не так?</p>\n"}