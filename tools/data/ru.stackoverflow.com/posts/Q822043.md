---
title: "C# - Отменить закрытие WebBrowser перехватом WM_DESTROY или WM_CLOSE"
se.owner.user_id: 295746
se.owner.display_name: "Евгений Капешко"
se.owner.link: "https://ru.stackoverflow.com/users/295746/%d0%95%d0%b2%d0%b3%d0%b5%d0%bd%d0%b8%d0%b9-%d0%9a%d0%b0%d0%bf%d0%b5%d1%88%d0%ba%d0%be"
se.link: "https://ru.stackoverflow.com/questions/822043/c-%d0%9e%d1%82%d0%bc%d0%b5%d0%bd%d0%b8%d1%82%d1%8c-%d0%b7%d0%b0%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b5-webbrowser-%d0%bf%d0%b5%d1%80%d0%b5%d1%85%d0%b2%d0%b0%d1%82%d0%be%d0%bc-wm-destroy-%d0%b8%d0%bb%d0%b8-wm-close"
se.question_id: 822043
se.post_type: question
se.score: 2
---
<p>У меня есть форма с экземпляром WebBrowser на ней. В него загружается страница сайта, на которой есть ссылка вида '&lt;a onClick="self.close();"&gt;Закрыть окно&lt;/a&gt;'.
При нажатии ее выдает сообщение, что скрипты пытается закрыть WebBrowser. Если согласиться, то WebBrowser просто зависает.
Поэтому стоит задача перехватить и отменить это закрытие.</p>

<p>После гугления нашел следующее решение. Расширить класс WebBrowser, чтобы перегрузить метод 'WndProc()', чтобы он ловил событие WM_PARENTNOTIFY, в котором передается WM_DESTROY. Однако, решение было предназначено для организации корректного закрытия формы браузера. В моем же случае мне нужно отменить закрытие и перейти по конкретному URL. Мне удается перехватить WM_DESTROY, но WebBrowser все равно убивается и зависает. Код использованного решения ниже:</p>

<pre><code>public class ExtendedWebBrowser : WebBrowser
  {
    // Define constants from winuser.h
    private const int WM_PARENTNOTIFY = 0x210;
    private const int WM_DESTROY = 2;

    public string BackUrl { get; set; };

    protected override void WndProc(ref Message m)
    {
      switch (m.Msg)
      {
        case WM_PARENTNOTIFY:
          if (!DesignMode)
          {
            if (m.WParam.ToInt32() == WM_DESTROY)
            {
              Navigate(BackUrl);
            }
          }
          DefWndProc(ref m);
          break;
        default:
          base.WndProc(ref m);
          break;
      }
    }
  }
</code></pre>

<p>Вопрос: Как предотвратить дальнейшую обработку WM_DESTROY или WM_CLOSE?</p>
