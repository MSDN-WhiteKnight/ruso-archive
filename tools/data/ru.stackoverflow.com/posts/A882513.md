---
title: "Answer 882513"
se.owner.user_id: 220553
se.owner.display_name: "EvgeniyZ"
se.owner.link: "https://ru.stackoverflow.com/users/220553/evgeniyz"
se.answer_id: 882513
se.question_id: 882416
se.post_type: answer
se.score: 8
se.is_accepted: False
---
<p>Уважаемый, ну мы же с вами программисты, что мешает нам написать простейшую программу по подсчету этих классов? Благо Microsoft <a href="https://referencesource.microsoft.com" rel="noreferrer">выкладывает</a> исходный код в удобном формате!</p>

<p>Попробуем это сделать?</p>

<ol>
<li>Добавляем в проект что нибудь для работы с HTML кодом, я буду использовать <code>HtmlAgilityPack</code>.</li>
<li>Заходим на нужный нам <a href="https://referencesource.microsoft.com" rel="noreferrer">сайт</a> и анализируем его:

<ul>
<li>Сбоку видим группы всяких namespace, просмотрев процесс загрузки сайта, мы увидим, что все это грузится со страницы <code>/results.html</code>.</li>
<li>Каждый namespace ведет по адресу <code>/#mscorlib,namespaces</code>. Опять смотрим как и от куда грузиться и получаем следующий адрес: <code>/mscorlib/namespaces.html</code>.</li>
<li>Теперь нужные нам классы. К сожалению Microsoft не делает пометок, что за тип такой в коде, но зато он отображает картинку типа, поигравшись с адресом изображений мы узнаем, что за классы отвечают изображения от <code>../content/icons/0.png</code> до <code>../content/icons/5.png</code></li>
</ul></li>
<li><p>Имея все эти данные - начинаем набрасывать код. Первым делом подготовим все необходимое, а точнее: вынесем адреса изображений в массив, а также сделаем базовый <code>Uri</code>:</p>

<pre><code>public static Uri BaseUri = new Uri("https://referencesource.microsoft.com/");
public static List&lt;string&gt; ClassImages = new List&lt;string&gt;
{
    "../content/icons/0.png",
    "../content/icons/1.png",
    "../content/icons/2.png",
    "../content/icons/3.png",
    "../content/icons/4.png",
    "../content/icons/5.png"
};
</code></pre></li>
<li><p>Создадим простой класс, который будет отправлять запрос и отдавать нам HTML:</p>

<pre><code>public static async Task&lt;string&gt; Get(Uri uri)
{
    string data;
    var cookieContainer = new CookieContainer();
    using (var httpClientHandler = new HttpClientHandler { CookieContainer = cookieContainer })
    {
        using (var httpClient = new HttpClient(httpClientHandler))
        {
            data = await httpClient.GetStringAsync(uri);
        }
    }

    return HttpUtility.HtmlDecode(data);
}
</code></pre></li>
<li><p>Создадим класс для одного Namespace. Так, как в коде Microsoft зовут это как Group - я решил не отставать от них:</p>

<pre><code>class Group
{
    public string Namespace { get; set; }
    public string Type { get; set; }
    public Uri Uri { get; set; }
    public int Classes { get; set; }
}
</code></pre></li>
<li><p>Теперь сделаем метод, который будет отдавать нам список всех Namespace на странице:</p>

<pre><code>public static async Task&lt;IEnumerable&lt;Group&gt;&gt; GetGroups()
{
    List&lt;Group&gt; groups = new List&lt;Group&gt;();
    var result = await Get(new Uri(BaseUri, "results.html"));
    var html = new HtmlDocument();
    html.LoadHtml(result);

    var groupsNodes = html.DocumentNode.SelectNodes("//div[@class='resultGroup']/a");
    if (groupsNodes != null)
    {
        foreach (var group in groupsNodes)
        {
            var link = group.GetAttributeValue("href", null);
            if (link != null)
            {
                var arr = link.Split(',');
                var nspace = arr[0].TrimStart('/', '#');
                var type = arr[1];

                groups.Add(new Group
                {
                    Namespace = nspace,
                    Type = type,
                    Uri = new Uri(BaseUri, $"{nspace}/{type}.html")
                });

            }
        }
    }

    return groups;
}
</code></pre></li>
<li><p>Теперь сделаем метод для подсчета изображений на странице конкретного Namespace (так, как Microsoft не очень любят частых подключений, делаем 3 попытки и увеличиваем интервал между подключениями):</p>

<pre><code>public static async Task&lt;bool&gt; CountClasses(Group group)
{
    if (group == null) return false;

    try
    {
        var result = await Get(group.Uri);
        var html = new HtmlDocument();
        html.LoadHtml(result);

        var classesIcons = html.DocumentNode.SelectNodes("//img[@class='tDNI']")
            .Select(x =&gt; x.GetAttributeValue("src", null))
            .Where(x =&gt; ClassImages.Contains(x));

        group.Classes = classesIcons.Count();
        return true;
    }
    catch (Exception )
    {
        return false;
    }
}
</code></pre></li>
<li><p>Теперь объединим все это:</p>

<pre><code>public static async Task Main(string[] args)
{
    var groups = await GetGroups();
    var list = groups.ToList();

    int count = 1;
    foreach (var group in list)
    {
        Console.Write($"[{count}/{list.Count}] {group.Namespace}. ");

        var status = false;
        var attempt = 0;

        while (!status)
        {
            status = await CountClasses(group);
            await Task.Delay(TimeSpan.FromSeconds(5));
            if (attempt &gt;= 3) break;
            if (!status) attempt++;
        }

        Console.WriteLine($"Результат: {group.Classes}");
        count++;
    }

    Console.WriteLine($"Всего: {list.Sum(x=&gt;x.Classes)}");
    Console.ReadKey();
}
</code></pre></li>
<li><p>Запускаем и любуемся результатом:</p>

<pre><code>[1/113] mscorlib. Результат: 1901
[2/113] PresentationFramework. Результат: 1793
[3/113] System.Web. Результат: 1854
[4/113] System. Результат: 1431
[5/113] System.Windows.Forms. Результат: 1381
[6/113] PresentationCore. Результат: 1203
[7/113] System.ServiceModel. Результат: 3216
[8/113] System.Data. Результат: 675
[9/113] System.Data.Entity. Результат: 1280
[10/113] System.Core. Результат: 668
[11/113] System.Xml. Результат: 702
[12/113] System.Activities. Результат: 705
[13/113] WindowsBase. Результат: 416
[14/113] System.Activities.Presentation. Результат: 705
[15/113] System.Drawing. Результат: 175
[16/113] Microsoft.VisualBasic. Результат: 86
[17/113] System.IdentityModel. Результат: 612
[18/113] System.Web.Extensions. Результат: 310
[19/113] System.Runtime.Serialization. Результат: 326
[20/113] System.Workflow.ComponentModel. Результат: 517
[21/113] System.Data.SqlXml. Результат: 313
[22/113] System.Data.Linq. Результат: 377
[23/113] UIAutomationClientsideProviders. Результат: 107
[24/113] PresentationBuildTasks. Результат: 211
[25/113] System.Configuration. Результат: 155
[26/113] System.Management. Результат: 109
[27/113] System.Data.Services. Результат: 184
[28/113] System.IO.Compression.FileSystem. Результат: 2
[29/113] System.IO.Log. Результат: 49
[30/113] System.Workflow.Activities. Результат: 411
[31/113] System.Management.Automation. Результат: 1638
[32/113] Microsoft.CSharp. Результат: 7
[33/113] System.Runtime.Serialization.Formatters.Soap. Результат: 0
[34/113] System.Web.Mobile. Результат: 348
[35/113] System.Web.Services. Результат: 304
[36/113] System.Security. Результат: 117
[37/113] System.Data.Services.Client. Результат: 137
[38/113] System.ServiceModel.Web. Результат: 131
[39/113] System.ServiceModel.Activities. Результат: 274
[40/113] System.Workflow.Runtime. Результат: 196
[41/113] System.ComponentModel.DataAnnotations. Результат: 58
[42/113] System.Activities.Core.Presentation. Результат: 171
[43/113] System.Design. Результат: 825
[44/113] Microsoft.Build.Tasks.v4.0. Результат: 283
[45/113] UIAutomationClient. Результат: 81
[46/113] System.Runtime.Remoting. Результат: 155
[47/113] Microsoft.JScript. Результат: 156
[48/113] System.Xml.Linq. Результат: 46
[49/113] System.Net. Результат: 70
[50/113] Microsoft.Build.Engine. Результат: 210
[51/113] System.Transactions. Результат: 170
[52/113] System.Messaging. Результат: 63
[53/113] System.Data.Entity.Design. Результат: 71
[54/113] Microsoft.Transactions.Bridge. Результат: 439
[55/113] Accessibility. Результат: 1
[56/113] System.ServiceModel.Internals. Результат: 129
[57/113] System.Web.DynamicData. Результат: 82
[58/113] System.WorkflowServices. Результат: 170
[59/113] System.ServiceModel.Discovery. Результат: 206
[60/113] ReachFramework. Результат: 327
[61/113] ComSvcConfig. Результат: 31
[62/113] System.AddIn. Результат: 61
[63/113] System.Runtime.Caching. Результат: 39
[64/113] System.ServiceModel.Activation. Результат: 83
[65/113] System.Xaml. Результат: 83
[66/113] SMSvcHost. Результат: 45
[67/113] System.ComponentModel.Composition. Результат: 108
[68/113] System.Deployment. Результат: 214
[69/113] System.Printing. Результат: 124
[70/113] System.Activities.DurableInstancing. Результат: 47
[71/113] Microsoft.Build.Framework. Результат: 48
[72/113] Microsoft.Build.Utilities.v4.0. Результат: 43
[73/113] Microsoft.Web.Administration. Результат: 73
[74/113] System.DirectoryServices. Результат: 104
[75/113] System.Numerics. Результат: 5
[76/113] System.ServiceModel.Channels. Результат: 72
[77/113] PresentationFramework.Aero. Результат: 14
[78/113] System.Runtime.DurableInstancing. Результат: 47
[79/113] WsatConfig. Результат: 56
[80/113] WsatUI. Результат: 45
[81/113] PresentationUI. Результат: 73
[82/113] System.Web.ApplicationServices. Результат: 14
[83/113] System.Data.Services.Design. Результат: 48
[84/113] PresentationFramework.Luna. Результат: 9
[85/113] System.Web.Entity. Результат: 33
[86/113] System.EnterpriseServices. Результат: 80
[87/113] XamlBuildTask. Результат: 32
[88/113] System.Data.DataSetExtensions. Результат: 14
[89/113] PresentationFramework.Royale. Результат: 9
[90/113] SMDiagnostics. Результат: 22
[91/113] System.Web.Extensions.Design. Результат: 89
[92/113] System.ServiceModel.Routing. Результат: 60
[93/113] System.IdentityModel.Selectors. Результат: 50
[94/113] UIAutomationTypes. Результат: 37
[95/113] System.ServiceProcess. Результат: 15
[96/113] Microsoft.Build.Utilities.v3.5. Результат: 27
[97/113] System.DirectoryServices.Protocols. Результат: 76
[98/113] PresentationFramework.Classic. Результат: 10
[99/113] System.Web.Entity.Design. Результат: 28
[100/113] Microsoft.VisualBasic.Activities.Compiler. Результат: 15
[101/113] UIAutomationProvider. Результат: 1
[102/113] System.ServiceModel.WasHosting. Результат: 16
[103/113] svcutil. Результат: 4
[104/113] System.Web.RegularExpressions. Результат: 76
[105/113] System.AddIn.Contract. Результат: 2
[106/113] System.Configuration.Install. Результат: 16
[107/113] System.Web.DataVisualization. Результат: 304
[108/113] System.Windows.Forms.DataVisualization. Результат: 264
[109/113] WindowsFormsIntegration. Результат: 8
[110/113] System.Xaml.Hosting. Результат: 13
[111/113] System.Drawing.Design. Результат: 15
[112/113] System.Windows.Presentation. Результат: 2
[113/113] System.Windows.Input.Manipulations. Результат: 13
Всего: 31556
</code></pre></li>
</ol>

<p>Получаем ответ: <strong>~31556 класса в C#</strong>.
P.S. Не стал расписывать как и что тут работает, а также не стал делать многопоточность и прочее (ибо программа на один запуск).</p>

<p>Также можно заметить, что <code>System.Runtime.Serialization.Formatters.Soap</code> выдал <code>0</code>, это потому что сервер меня походу заблокировал и выдает вечно <code>Server encountered an internal error.</code>. Так что в общий подсчет этот Namestace не вошел.</p>

<p>И также, хочу заметить, что я не уверен, что все классы здесь находятся или все грамотно отображаются в боковом меню на сайте. По этому результат приблизительный...</p>
