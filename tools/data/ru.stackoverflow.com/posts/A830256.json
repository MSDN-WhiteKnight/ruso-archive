{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":0,"last_activity_date":1526741431,"creation_date":1526741431,"answer_id":830256,"question_id":98589,"body":"<p>Класс HtmlDocument не содержит конструктора, позволяющего создать пустой документ. Тем не менее, можно это сделать с помощью невидимого WebBrowser:</p>\n\n<pre><code>HtmlDocument htmldoc;\n\n//создадим WebBrowser и загрузим в него пустой документ\nWebBrowser wb = new WebBrowser();         \nwb.DocumentText = \"\";\nwhile(wb.ReadyState != WebBrowserReadyState.Complete)Application.DoEvents();\n/*На практике загрузка пустой строки произойдет очень быстро, поэтому\n можно использовать блокирующий цикл вместо подписки на событие DocumentCompleted*/\n\n//заполним содержимое документа\nhtmldoc = wb.Document;\nhtmldoc.Title = \"Hello\";            \n\nHtmlElement el = htmldoc.CreateElement(\"h1\");\nel.InnerText = \"Hello, world!\";\nhtmldoc.Body.AppendChild(el);\n\nel = htmldoc.CreateElement(\"div\");\nel.InnerText = \"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.\";\nhtmldoc.Body.AppendChild(el);\n\n//получаем все содержимое документа в виде html\ntextBox1.Text = htmldoc.GetElementsByTagName(\"html\")[0].OuterHtml;\n</code></pre>\n\n<p>Или добавить ссылку на COM-библиотеку <strong>Microsoft HTML Object Library</strong>, вручную создать экземпляр класса <em>MSHTML.HTMLDocument</em> и затем на основе него создать <em>HtmlDocument</em> путем вызова его  закрытого конструктора:</p>\n\n<pre><code>using System;\nusing System.IO;\nusing System.Collections.Generic;\nusing System.ComponentModel;\nusing System.Text;\nusing System.Windows.Forms;\nusing System.Reflection;\nusing System.Runtime.InteropServices;\nusing System.Diagnostics;\n\nnamespace WinFormsTest\n{\n    public partial class Form1 : Form\n    {\n        /* Создает новый пустой экземпляр HtmlDocument*/\n        public static HtmlDocument CreateHtmlDocument()\n        {\n            Assembly winforms = typeof(Form).Assembly; //System.Windows.Forms\n\n            //создадим служебный класс HtmlShimManager\n            Type t = winforms.GetType(\"System.Windows.Forms.HtmlShimManager\");\n            object obj = Activator.CreateInstance(t, true);\n\n            //создадим документ и загрузим в него пустую строку\n            var doc = new MSHTML.HTMLDocument();\n            MSHTML.IHTMLDocument2 doc2 = (MSHTML.IHTMLDocument2)doc;\n            doc2.write(\"\");\n            doc2.close();\n\n            HtmlDocument htmldoc = null;\n\n            //создаем HtmlDocument с помощью закрытого конструктора\n            htmldoc = (HtmlDocument)Activator.CreateInstance(\n            typeof(HtmlDocument),\n            BindingFlags.Instance | BindingFlags.NonPublic,\n            null,\n            new object[] { obj, doc },\n            System.Globalization.CultureInfo.InvariantCulture);\n\n            return htmldoc;\n        }\n\n        /* Освобождает неуправляемые ресурсы, принадлежащие HtmlDocument*/\n        public static void ReleaseHtmlDocument(HtmlDocument doc)\n        {\n            Type t = typeof(HtmlDocument);\n            try\n            {\n                IDisposable shim = (IDisposable)t.InvokeMember(\n                    \"shimManager\",\n                    BindingFlags.GetField | BindingFlags.NonPublic | BindingFlags.Instance,\n                    null, doc, new object[0]);\n                shim.Dispose();                \n            }\n            catch (Exception ex)\n            {\n                Debug.WriteLine(ex.ToString());\n            }\n            Marshal.ReleaseComObject(doc.DomDocument);\n        }\n\n        public Form1()\n        {\n            InitializeComponent();\n        }\n\n\n        private void button1_Click(object sender, EventArgs e)\n        {\n            HtmlDocument htmldoc;\n            htmldoc    = CreateHtmlDocument(); //создадим документ\n\n            //заполним содержимое документа\n            htmldoc.Title = \"Hello\";\n\n            HtmlElement el = htmldoc.CreateElement(\"h1\");\n            el.InnerText = \"Hello, world!\";\n            htmldoc.Body.AppendChild(el);\n\n            el = htmldoc.CreateElement(\"div\");\n            el.InnerText = \"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.\";\n            el.Style = \"color: red\";\n            htmldoc.Body.AppendChild(el);\n\n            //получаем все содержимое документа в виде html\n            textBox1.Text = htmldoc.GetElementsByTagName(\"html\")[0].OuterHtml;\n\n            //освобождаем неуправляемые ресурсы, связанные с HtmlDocument\n            ReleaseHtmlDocument(htmldoc);            \n        }      \n\n    }   \n\n}\n</code></pre>\n"}