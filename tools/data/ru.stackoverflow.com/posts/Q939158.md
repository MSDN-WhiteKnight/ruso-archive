---
title: "Без причины закрывается консольное приложение с сервером TcpListener на Windows 7"
se.owner.user_id: 294599
se.owner.display_name: "Mart"
se.owner.link: "https://ru.stackoverflow.com/users/294599/mart"
se.link: "https://ru.stackoverflow.com/questions/939158/%d0%91%d0%b5%d0%b7-%d0%bf%d1%80%d0%b8%d1%87%d0%b8%d0%bd%d1%8b-%d0%b7%d0%b0%d0%ba%d1%80%d1%8b%d0%b2%d0%b0%d0%b5%d1%82%d1%81%d1%8f-%d0%ba%d0%be%d0%bd%d1%81%d0%be%d0%bb%d1%8c%d0%bd%d0%be%d0%b5-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b5-%d1%81-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%be%d0%bc-tcplistener-%d0%bd%d0%b0-windows"
se.question_id: 939158
se.post_type: question
se.score: 1
---
<p>Запускаю консольное приложение с простеньким сервером на Windows 7. Первые несколько часов работает норм. А потом неожиданно консольное приложение закрывается, даже без сообщения об ошибке. Что я не так сделал?</p>

<pre><code>namespace Server_Smen_IP
{
    class Server
    {
        TcpListener Listener;
        public Server(int Port)
        {
            Listener = new TcpListener(IPAddress.Any, Port);
            Listener.Start();
            new Client(Listener.AcceptTcpClient());
            while (true)
            {
                TcpClient Client = Listener.AcceptTcpClient();
                Thread Thread = new Thread(new ParameterizedThreadStart(ClientThread));
                Thread.Start(Client);
            }
        }
        ~Server()
        {
            if (Listener != null)
            {
                Listener.Stop();
            }
        }
        static void Main(string[] args)
        {
            new Server(80);
        }
        static void ClientThread(Object StateInfo)
        {
            new Client((TcpClient)StateInfo);
        }

    class Client
    {
        public Client(TcpClient Client)
        {
            string Request = "";
            byte[] Buffer = new byte[1024];
            int Count;
            while ((Count = Client.GetStream().Read(Buffer, 0, Buffer.Length)) &gt; 0)
            {
                Request += Encoding.ASCII.GetString(Buffer, 0, Count);
                if (Request.IndexOf("\r\n\r\n") &gt;= 0 || Request.Length &gt; 4096)
                {
                    break;
                }
            }
            string Html = Моя_Процедура_Над_Телом_запроса(Request)
            string Str = "HTTP/1.1 200 OK\nContent-type: text/html\nContent-Length:" + Html.Length.ToString() + "\n\n" + Html;
            byte[] Buff = Encoding.ASCII.GetBytes(Str);
            Client.GetStream().Write(Buff, 0, Buff.Length);
            Client.Close();
        }
    }
}
</code></pre>
