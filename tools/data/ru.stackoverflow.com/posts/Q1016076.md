---
title: "GetNumberOfConsoleFonts() работает некорректно"
se.owner.user_id: 348132
se.owner.display_name: "NightLion"
se.owner.link: "https://ru.stackoverflow.com/users/348132/nightlion"
se.link: "https://ru.stackoverflow.com/questions/1016076/getnumberofconsolefonts-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0%d0%b5%d1%82-%d0%bd%d0%b5%d0%ba%d0%be%d1%80%d1%80%d0%b5%d0%ba%d1%82%d0%bd%d0%be"
se.question_id: 1016076
se.post_type: question
se.score: 2
---
<p>В своём консольном проекте на C# я решил реализовать возможность смены шрифта консоли средствами самой программы. Алгоритм действий:</p>

<ol>
<li>С помощью WinAPI-функции GetNumberOfConsoleFonts() получить
количество доступных для консоли шрифтов.</li>
<li>С помощью WinAPI-функции GetConsoleFontInfo() получить их индексы.</li>
<li>Последовательное применение WinAPI-функций SetConsoleFont() и
GetCurrentConsoleFontEx() для каждого индекса, чтобы получить более
детальную информацию о шрифтах.</li>
<li>На основе полученной информации организовать диалог с выбором шрифта.</li>
</ol>

<p>Проблема в том, что GetNumberOfConsoleFonts() постоянно возвращает 0, делая все другие шаги бессмысленными. В чём может быть причина? Можно ли как-нибудь иначе получить количество доступных для консоли шрифтов или их индексы?</p>

<pre><code>[DllImport("kernel32.dll", SetLastError = true)] 
static extern uint GetNumberOfConsoleFonts();

//Использование:
uint fontsCount = GetNumberOfConsoleFonts();
</code></pre>

<p>У меня установлены Windows 10 и Visual Studio 2019.</p>

<p><strong><em>Дополнение от 26.08.2019:</em></strong><br>
В общем, я так и не нашёл способа заставить функции <code>GetNumberOfConsoleFonts</code>, <code>GetConsoleFontInfo</code> и <code>SetConsoleFont</code> заработать. Пока вместо этого использую следующий алгоритм:</p>

<ol>
<li>Из ветки реестра <code>HKEY_CURRENT_USER\Software\Microsoft\Shared
Tools\Panose</code> (похоже, содержит имена и некоторые параметры шрифтов)
получаю все пары <code>Имя:Значение</code>.</li>
<li>Выполняю отсеивание, оставляя только те, в которых четвёртый байт равен 0x09 (возможно именно это указывает на моноширинность шрифта).</li>
<li>Для каждого из оставшихся имён шрифтов последовательно применяю <code>SetCurrentConsoleFontEx</code> и <code>GetCurrentConsoleFontEx</code>, чтобы проверить может ли данный шрифт использоваться в консоли (если свойство <code>FaceName</code> структуры <code>CONSOLE_FONT_INFO_EX</code> что передаётся в <code>SetCurrentConsoleFontEx</code> совпадает с свойством <code>FaceName</code> структуры <code>CONSOLE_FONT_INFO_EX</code> что возвращается <code>GetCurrentConsoleFontEx</code>, значит консоль может использовать этот шрифт).</li>
<li>Из тех, что были успешно применены, формирую список, который и использую в диалоге выбора шрифта.</li>
</ol>
