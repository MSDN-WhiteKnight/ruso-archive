{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":1,"last_activity_date":1516640600,"last_edit_date":1516640600,"creation_date":1516393135,"answer_id":773093,"question_id":772547,"body":"<p>Свойство <code>DocumentText</code> возвращает то, что вы просите - код документа. Код содержимого iframe'ов в него не входит, поскольку iframe - это больше, чем просто механизм подстановки одного HTML внутрь другого (*). Чтобы получить документ вместе с содержимым iframe'ов, единственный способ - пройти по всем iframe'ам, взять их содержимое (например, через интерфейс <code>MSHTML.IHTMLIFrameElement3</code>) и подставить в исходный документ. Понятно, нельзя получить содержимое, если iframe смотрит в другой домен.</p>\n\n<p>Как-то так:</p>\n\n<pre><code>using System;\nusing System.Collections.Generic;\nusing System.ComponentModel;\nusing System.Runtime.InteropServices;\nusing System.Text;\nusing System.Windows.Forms;\n\nnamespace WebBrowserTest\n{\n    public partial class Form1 : Form\n    {\n        public Form1()\n        {\n            InitializeComponent();            \n        }\n\n        public String DomDocumentText\n        {\n            get\n            {\n                var document = webBrowser1.Document;\n                string returnstr = \"\";\n\n                MSHTML.IHTMLDocument3 doc3 = null;\n                MSHTML.HTMLDocument new_doc = null;\n                MSHTML.IHTMLDocument2 doc2 = null;\n                MSHTML.IHTMLElementCollection elems = null;\n                MSHTML.IHTMLDocument3 new_doc3 = null;\n                MSHTML.IHTMLElementCollection elems_new = null;\n\n                MSHTML.IHTMLDocument3 child_doc = null;\n                MSHTML.IHTMLElement content = null;\n                MSHTML.IHTMLElement content_new = null;\n                MSHTML.IHTMLElementCollection elem_col = null;\n\n\n                try\n                {\n                    doc3 = (MSHTML.IHTMLDocument3)document.DomDocument;//исходный документ\n\n                    new_doc = new MSHTML.HTMLDocument();//копия документа\n\n                    doc2 = new_doc as MSHTML.IHTMLDocument2;\n                    doc2.write(webBrowser1.DocumentText);//создаем копию документа\n\n                    //получаем все iframe в документе и его копии...\n\n                    elems = doc3.getElementsByTagName(\"iframe\");\n\n                    new_doc3 = new_doc as MSHTML.IHTMLDocument3;\n\n                    elems_new = (new_doc3).getElementsByTagName(\"iframe\");\n\n\n                    int i = 0;\n                    foreach (MSHTML.IHTMLIFrameElement3 elem in elems) //для каждого iframe...\n                    {\n                        try\n                        {\n                            child_doc = elem.contentDocument as MSHTML.IHTMLDocument3;\n                            elem_col = child_doc.getElementsByTagName(\"body\");\n                            if (elem_col == null || elem_col.length == 0) { i++; continue; }\n\n                            content = (MSHTML.IHTMLElement)elem_col.item(0);\n                            string str = (content).innerHTML;//получаем содержимое iframe\n                            content_new = elems_new.item(i) as MSHTML.IHTMLElement;\n                            (content_new).outerHTML = str;//заменяем iframe на его содержимое                  \n                            i++;\n                        }\n                        catch (Exception ex)\n                        {\n                            //для iframe, URL которых в другом домене, будет исключение\n                            //HRESULT: 0x80070005 (E_ACCESSDENIED)\n                            System.Diagnostics.Debug.WriteLine(\"Can't process iframe \" + i.ToString());\n                            System.Diagnostics.Debug.WriteLine(ex.Message);\n                        }\n                        finally\n                        {\n                            //Очистка ресурсов, задействованных в цикле...\n                            if (child_doc != null)\n                            {\n                                Marshal.ReleaseComObject(child_doc); child_doc = null;\n                            }\n\n                            if (elem_col != null)\n                            {\n                                Marshal.ReleaseComObject(elem_col); elem_col = null;\n                            }\n\n                            if (content != null)\n                            {\n                                Marshal.ReleaseComObject(content); content = null;\n                            }\n\n                            if (content_new != null)\n                            {\n                                Marshal.ReleaseComObject(content_new); content_new = null;\n                            }\n                        }\n                    }//end foreach\n\n\n                    returnstr = new_doc.documentElement.innerHTML;\n                    return returnstr;\n                }\n                finally\n                {                \n                    //Окончательная очистка ресурсов...\n                    if (doc3 != null) Marshal.ReleaseComObject(doc3);\n                    if (new_doc != null) Marshal.ReleaseComObject(new_doc);\n                    if (doc2 != null) Marshal.ReleaseComObject(doc2);\n                    if (elems != null) Marshal.ReleaseComObject(elems);\n                    if (new_doc3 != null) Marshal.ReleaseComObject(new_doc3);\n                    if (elems_new != null) Marshal.ReleaseComObject(elems_new);\n                    if (child_doc != null) Marshal.ReleaseComObject(child_doc);\n                    if (content != null) Marshal.ReleaseComObject(content);\n                    if (content_new != null) Marshal.ReleaseComObject(content_new);\n                    if (elem_col != null) Marshal.ReleaseComObject(elem_col);\n                }\n            }\n        }\n\n        private void button1_Click(object sender, EventArgs e)\n        {\n            MessageBox.Show(DomDocumentText);\n        }\n    }\n}\n</code></pre>\n\n<p>Для использования нужно подключить библиотеку COM-объектов IE (в Visual Studio  <kbd>Добавить ссылку</kbd> -> <kbd>СОМ</kbd> -> <kbd>Microsoft HTML Object Library</kbd>, либо вручную указать файл mshtml.tlb). </p>\n\n<p><strong>Примечания</strong></p>\n\n<p>(*) - Для iframe браузер создает отдельное окно внутри основного окна, которое может, в общем случае, отображать не HTML, а документ другого типа. Поэтому в модели DOM свойство <code>InnerHTML</code> у iframe соответствует не его содержимому, а замещающему тексту для браузеров без поддержки iframe, который можно поместить внутрь тега iframe (что редко используется в наше время).</p>\n"}