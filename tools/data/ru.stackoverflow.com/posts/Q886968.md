---
title: "Вывод имени USB-девайса"
se.owner.user_id: 293818
se.owner.display_name: "Flone"
se.owner.link: "https://ru.stackoverflow.com/users/293818/flone"
se.link: "https://ru.stackoverflow.com/questions/886968/%d0%92%d1%8b%d0%b2%d0%be%d0%b4-%d0%b8%d0%bc%d0%b5%d0%bd%d0%b8-usb-%d0%b4%d0%b5%d0%b2%d0%b0%d0%b9%d1%81%d0%b0"
se.question_id: 886968
se.post_type: question
se.score: 3
---
<p>Пытаюсь вывести имя нового USB-девайса, когда его подключают. Проблема в том, что при вставке флешки messagebox появляется, но на нем ничего нет. Где-то давно находил в интернете: "Когда приходит WM_DEVICECHANGE, смотрим, чтобы wParam был равен DBT_DEVICEARRIVAL. В lParam тогда будет указатель на DEV_BROADCAST_DEVICEINTERFACE.
Если в его dbcc_devicetype будет значение DBT_DEVTYP_DEVICEINTERFACE, тогда в
dbcc_name будет имя устройства." Я пытался что-то написать и как-то получить этот указатель из lParam (см. код ниже), но этот указатель не содержит поля-имени. Вообщем, я понятия не имею что нужно написать после проверки wParam и просто написал примерный код. Прошу помощи с решением этой задачи.</p>

<p>Глобальная часть:</p>

<pre><code>#include &lt;windows.h&gt;
//DEV_BROADCAST_DEVICEINTERFACE struct
#include "dbt.h"
//contains initguid.h and usbiodef.h
#include "GUIDheader.h"

HDEVNOTIFY NotificationHande;
DEV_BROADCAST_DEVICEINTERFACE DeviceStruct;
</code></pre>

<p>Оконная процедура:</p>

<pre><code>LRESULT CALLBACK WndProc(HWND hWnd,UINT uMsg,WPARAM wParam,LPARAM lParam)
{
    switch (uMsg)
    {
    case(WM_CREATE):
        DeviceStruct.dbcc_size = sizeof(DeviceStruct);
        DeviceStruct.dbcc_classguid = GUID_DEVINTERFACE_USB_DEVICE;
        DeviceStruct.dbcc_devicetype = DBT_DEVTYP_DEVICEINTERFACE;
        NotificationHande = RegisterDeviceNotification(hWnd, &amp;DeviceStruct, DEVICE_NOTIFY_WINDOW_HANDLE | DEVICE_NOTIFY_ALL_INTERFACE_CLASSES);
        break;
    case (WM_DESTROY):
        PostQuitMessage(0);
        break;
    case(WM_DEVICECHANGE):
        if (wParam == DBT_DEVICEARRIVAL)
        {
            DEV_BROADCAST_HDR* NewDevice = (DEV_BROADCAST_HDR*)lParam;
            if (NewDevice-&gt;dbch_devicetype == DBT_DEVTYP_DEVICEINTERFACE)
            {
                MessageBox(0,(LPCSTR)DeviceStruct.dbcc_name, (LPCSTR)"WOW", MB_OK);
            }
        }
        break;
    default:
        return DefWindowProc(hWnd, uMsg, wParam, lParam);
    }
    return 0;
}
</code></pre>

<p>Основная функция:</p>

<pre><code>int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
{
    // Main window handle
    HWND hMainWnd;

    WNDCLASSEX wc;                      
    wc.cbSize = sizeof(wc);
    wc.style = CS_HREDRAW | CS_VREDRAW;
    wc.lpfnWndProc = WndProc;
    wc.lpszMenuName = NULL;             
    wc.lpszClassName = "WindowClass";           
    wc.cbWndExtra = NULL;
    wc.cbClsExtra = NULL;
    wc.hbrBackground = (HBRUSH)GetStockObject(WHITE_BRUSH);
    wc.hInstance = hInstance;
    wc.hIcon = LoadIcon(NULL, IDI_WINLOGO);
    wc.hIconSm = LoadIcon(NULL, IDI_WINLOGO);
    wc.hCursor = LoadCursor(NULL, IDC_ARROW);

    if (!RegisterClassEx(&amp;wc))
    {
        MessageBox(0, "Cannot register class.", "Error", MB_OK);
        return 0;
    }

    hMainWnd = CreateWindowEx(0, "WindowClass", "", WS_SYSMENU, CW_USEDEFAULT, 0, CW_USEDEFAULT, 0, 0, 0, hInstance, 0);
    if (hMainWnd == 0)
    {
        MessageBox(0, "Cannot create window.", "Error", MB_OK);
        return 0;
    }

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    MSG message;
    while (GetMessage(&amp;message, NULL, 0, 0))
    {
        TranslateMessage(&amp;message);
        DispatchMessage(&amp;message);
    }

    DestroyWindow(hMainWnd);

    UnregisterClass(wc.lpszClassName, hInstance);

    return 0;
}
</code></pre>
