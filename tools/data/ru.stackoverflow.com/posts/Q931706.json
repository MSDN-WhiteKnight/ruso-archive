{"tags":["c#","mysql","кодировка","rtf"],"owner":{"reputation":97,"user_id":291056,"user_type":"registered","profile_image":"https://www.gravatar.com/avatar/d0686ffa9225c2710cd3dc1683e9e9dd?s=128&d=identicon&r=PG","display_name":"Aleks Keller","link":"https://ru.stackoverflow.com/users/291056/aleks-keller"},"is_answered":true,"view_count":191,"accepted_answer_id":935834,"answer_count":3,"score":2,"last_activity_date":1548268373,"creation_date":1547401658,"last_edit_date":1547483028,"question_id":931706,"link":"https://ru.stackoverflow.com/questions/931706/c-%d0%b8-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d1%8c-%d0%b2-rtf-%d1%88%d0%b0%d0%b1%d0%bb%d0%be%d0%bd","title":"C# и запись в .rtf-шаблон","body":"<p>коллеги.</p>\n\n<p>Есть БД MySQL с русским текстом.\nЕсть приложение C# WinForms x86 .net 3.5.\nЕсть файл <code>.rtf</code> с вставками вида #template# и русским текстом.</p>\n\n<p>Задача: записать текст из БД в нужные места в файле.\nЧитаю через <code>File.ReadAllText</code>, затем склеиваю строки и пишу обратно через <code>File.WriteAllText</code> в новый файл. </p>\n\n<p>И получаю кракозябры вместо вставленного текста. При этом тот текст, что был, остаётся в порядке. </p>\n\n<p>Пробовал читать в одной кодировке, писать в другой... Один пёс. </p>\n\n<p>Может, кто-то сталкивался с этим <code>.rtf</code> - какую комбинацию кодировок посоветуете для базы данных, самого файла, <code>File.ReadAllText</code> и <code>File.WriteAllText</code>? Или может юзать <code>File.Write/ReadAllBytes</code>. Или перекодировать на лету вставляемые куски текста? </p>\n\n<p>Заранее спасибо.</p>\n\n<p>Я до сих пор не въехал, какая родная кодировка у <code>.rtf</code> - 1251 или 1252.</p>\n\n<p>UPD:\nКод:</p>\n\n<pre><code>string agreementTemplate = File.ReadAllText(\"PaymentTemplate.rtf\", Encoding.GetEncoding(1251));\nagreementTemplate = agreementTemplate.Replace(\"#klientName#\", CurrentCredit.Client);\nagreementTemplate = agreementTemplate.Replace(\"#klientAdr#\", CurrentCredit.ClientAdr);\nFile.WriteAllText(\"Сведения о платежах для договора №\" + CurrentCredit.Number + \".doc\", agreementTemplate, Encoding.GetEncoding(1251));\n</code></pre>\n\n<p>Результат:\nАндрей Семёнов\nóë. Ëåíèíà, 24</p>\n\n<p>Добавил новый файл для примера.\nПри загрузке:\n\"{\\rtf1\\ansi\\ansicpg1251\\deff0{\\fonttbl{\\f0\\fnil\\fcharset204 Calibri;}{\\f1\\fnil\\fcharset0 Calibri;}}\\r\\n\\viewkind4\\uc1\\pard\\sa200\\sl276\\slmult1\\lang1049\\f0\\fs22\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\b\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\ul\\b0\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\b\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\ulnone\\b0\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2: \\lang1033\\f1 #replace#\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\par\\r\\n\\par\\r\\n}\\r\\n\"</p>\n\n<p>После замены replace на русский текст</p>\n\n<p>\"{\\rtf1\\ansi\\ansicpg1251\\deff0{\\fonttbl{\\f0\\fnil\\fcharset204 Calibri;}{\\f1\\fnil\\fcharset0 Calibri;}}\\r\\n\\viewkind4\\uc1\\pard\\sa200\\sl276\\slmult1\\lang1049\\f0\\fs22\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\b\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\ul\\b0\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\b\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\ulnone\\b0\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2: \\lang1033\\f1\\'c0\\'ed\\'e4\\'f0\\'e5\\'e9 \\'d1\\'e5\\'ec\\'b8\\'ed\\'ee\\'e2\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\lang1049\\f0\\'d0\\'f3\\'f1\\'f1\\'ea\\'e8\\'e9 \\'f2\\'e5\\'ea\\'f1\\'f2\\lang1033\\f1\\par\\r\\n\\par\\r\\n\\par\\r\\n}\\r\\n\"</p>\n\n<p>Содержимое файла</p>\n\n<p>Русский текст\nРусский текст (жирным)\nРусский текст (подчёркнутым)\nРусский текст (жирным подч)\nРусский текст\nРусский текст: #replace#\nРусский текст\nРусский текст</p>\n\n<p>Обновление: решение проблемы, как обычно, с помощью костылей. Вместо шаблона вида \"#replace#\" делаем шаблон КИРИЛЛИЦЕЙ вида \"ИмяКлиента\". </p>\n\n<p>То есть текст в шаблоне: \"клиент, в лице ИмяКлиента, обязывается...\"</p>\n\n<p>Затем, с помощью функции, предложенной nick_n_a, делаем такую кракозябру:</p>\n\n<pre><code>templateStr = loadfile...\ntemplateStr = templateStr.Replace(ToRtf(\"ИмяКлиента\"), ToRtf(CurrentCredit.Name));\n</code></pre>\n\n<p>где CurrentCredit.Name - русский текст из БД\nНа кодировку ложим болт ибо теперь неважно.</p>\n\n<p>В общем, оно работает. Но... сами понимаете. Кто придумает что-то лучше - милости просим)</p>\n\n<p>ЗЫ: правда, на основных файлах ещё не проверял, если что - вернусь)</p>\n"}