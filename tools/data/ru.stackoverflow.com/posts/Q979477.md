---
title: "Не удается считать имя локали, куча повреждается, как исправить 2 метода?"
se.owner.user_id: 206435
se.owner.display_name: "ヒミコ"
se.owner.link: "https://ru.stackoverflow.com/users/206435/%e3%83%92%e3%83%9f%e3%82%b3"
se.link: "https://ru.stackoverflow.com/questions/979477/%d0%9d%d0%b5-%d1%83%d0%b4%d0%b0%d0%b5%d1%82%d1%81%d1%8f-%d1%81%d1%87%d0%b8%d1%82%d0%b0%d1%82%d1%8c-%d0%b8%d0%bc%d1%8f-%d0%bb%d0%be%d0%ba%d0%b0%d0%bb%d0%b8-%d0%ba%d1%83%d1%87%d0%b0-%d0%bf%d0%be%d0%b2%d1%80%d0%b5%d0%b6%d0%b4%d0%b0%d0%b5%d1%82%d1%81%d1%8f-%d0%ba%d0%b0%d0%ba-%d0%b8%d1%81%d0%bf%d1%80%d0%b0%d0%b2%d0%b8%d1%82%d1%8c-2-%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d0%b0"
se.question_id: 979477
se.post_type: question
se.score: 0
---
<p>Имеется следующий интерфейс:</p>

<pre><code>/// &lt;summary&gt;
///     Represents a collection of strings indexed by locale name.
/// &lt;/summary&gt;
[ComImport]
[Guid("08256209-099a-4b34-b86d-c22b110e7771")]
[InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]
public interface IDWriteLocalizedStrings
{
    /// &lt;summary&gt;
    ///     Gets the number of language/string pairs.
    /// &lt;/summary&gt;
    uint GetCount();

    /// &lt;summary&gt;
    ///     Gets the index of the item with the specified locale name.
    /// &lt;/summary&gt;
    /// &lt;param name="localeName"&gt;Locale name to look for.&lt;/param&gt;
    /// &lt;param name="index"&gt;Receives the zero-based index of the locale name/string pair.&lt;/param&gt;
    /// &lt;param name="exists"&gt;Receives TRUE if the locale name exists or FALSE if not.&lt;/param&gt;
    /// &lt;returns&gt;
    ///     Standard HRESULT error code. If the specified locale name does not exist, the return value is S_OK,
    ///     but *index is UINT_MAX and *exists is FALSE.
    /// &lt;/returns&gt;
    [PreserveSig]
    int FindLocaleName([MarshalAs(UnmanagedType.LPWStr)] string localeName, out uint index,
        [MarshalAs(UnmanagedType.Bool)] out bool exists);

    /// &lt;summary&gt;
    ///     Gets the length in characters (not including the null terminator) of the locale name with the specified index.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the locale name.&lt;/param&gt;
    /// &lt;param name="length"&gt;Receives the length in characters, not including the null terminator.&lt;/param&gt;
    /// &lt;returns&gt;
    ///     Standard HRESULT error code.
    /// &lt;/returns&gt;
    [PreserveSig]
    int GetLocaleNameLength(uint index, out uint length);

    /// &lt;summary&gt;
    ///     Copies the locale name with the specified index to the specified array.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the locale name.&lt;/param&gt;
    /// &lt;param name="localeName"&gt;Character array that receives the locale name.&lt;/param&gt;
    /// &lt;param name="size"&gt;
    ///     Size of the array in characters. The size must include space for the terminating
    ///     null character.
    /// &lt;/param&gt;
    /// &lt;returns&gt;
    ///     Standard HRESULT error code.
    /// &lt;/returns&gt;
    [PreserveSig]
    int GetLocaleName(uint index, [MarshalAs(UnmanagedType.LPArray)] [In] ref byte[] localeName, uint size);

    /// &lt;summary&gt;
    ///     Gets the length in characters (not including the null terminator) of the string with the specified index.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the string.&lt;/param&gt;
    /// &lt;param name="length"&gt;Receives the length in characters, not including the null terminator.&lt;/param&gt;
    /// &lt;returns&gt;
    ///     Standard HRESULT error code.
    /// &lt;/returns&gt;
    [PreserveSig]
    int GetStringLength(uint index, out uint length);

    /// &lt;summary&gt;
    ///     Copies the string with the specified index to the specified array.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the string.&lt;/param&gt;
    /// &lt;param name="stringBuffer"&gt;Character array that receives the string.&lt;/param&gt;
    /// &lt;param name="size"&gt;
    ///     Size of the array in characters. The size must include space for the terminating
    ///     null character.
    /// &lt;/param&gt;
    /// &lt;returns&gt;
    ///     Standard HRESULT error code.
    /// &lt;/returns&gt;
    [PreserveSig]
    int GetString(uint index, [MarshalAs(UnmanagedType.LPWStr)] out string stringBuffer, uint size);
}
</code></pre>

<p>Но оригинальный интерфейс определен вот так:</p>

<pre><code>/// &lt;summary&gt;
/// Represents a collection of strings indexed by locale name.
/// &lt;/summary&gt;
interface DWRITE_DECLARE_INTERFACE("08256209-099a-4b34-b86d-c22b110e7771") IDWriteLocalizedStrings : public IUnknown
{
    /// &lt;summary&gt;
    /// Gets the number of language/string pairs.
    /// &lt;/summary&gt;
    STDMETHOD_(UINT32, GetCount)() PURE;

    /// &lt;summary&gt;
    /// Gets the index of the item with the specified locale name.
    /// &lt;/summary&gt;
    /// &lt;param name="localeName"&gt;Locale name to look for.&lt;/param&gt;
    /// &lt;param name="index"&gt;Receives the zero-based index of the locale name/string pair.&lt;/param&gt;
    /// &lt;param name="exists"&gt;Receives TRUE if the locale name exists or FALSE if not.&lt;/param&gt;
    /// &lt;returns&gt;
    /// Standard HRESULT error code. If the specified locale name does not exist, the return value is S_OK, 
    /// but *index is UINT_MAX and *exists is FALSE.
    /// &lt;/returns&gt;
    STDMETHOD(FindLocaleName)(
        _In_z_ WCHAR const* localeName,
        _Out_ UINT32* index,
        _Out_ BOOL* exists
        ) PURE;

    /// &lt;summary&gt;
    /// Gets the length in characters (not including the null terminator) of the locale name with the specified index.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the locale name.&lt;/param&gt;
    /// &lt;param name="length"&gt;Receives the length in characters, not including the null terminator.&lt;/param&gt;
    /// &lt;returns&gt;
    /// Standard HRESULT error code.
    /// &lt;/returns&gt;
    STDMETHOD(GetLocaleNameLength)(
        UINT32 index,
        _Out_ UINT32* length
        ) PURE;

    /// &lt;summary&gt;
    /// Copies the locale name with the specified index to the specified array.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the locale name.&lt;/param&gt;
    /// &lt;param name="localeName"&gt;Character array that receives the locale name.&lt;/param&gt;
    /// &lt;param name="size"&gt;Size of the array in characters. The size must include space for the terminating
    /// null character.&lt;/param&gt;
    /// &lt;returns&gt;
    /// Standard HRESULT error code.
    /// &lt;/returns&gt;
    STDMETHOD(GetLocaleName)(
        UINT32 index,
        _Out_writes_z_(size) WCHAR* localeName,
        UINT32 size
        ) PURE;

    /// &lt;summary&gt;
    /// Gets the length in characters (not including the null terminator) of the string with the specified index.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the string.&lt;/param&gt;
    /// &lt;param name="length"&gt;Receives the length in characters, not including the null terminator.&lt;/param&gt;
    /// &lt;returns&gt;
    /// Standard HRESULT error code.
    /// &lt;/returns&gt;
    STDMETHOD(GetStringLength)(
        UINT32 index,
        _Out_ UINT32* length
        ) PURE;

    /// &lt;summary&gt;
    /// Copies the string with the specified index to the specified array.
    /// &lt;/summary&gt;
    /// &lt;param name="index"&gt;Zero-based index of the string.&lt;/param&gt;
    /// &lt;param name="stringBuffer"&gt;Character array that receives the string.&lt;/param&gt;
    /// &lt;param name="size"&gt;Size of the array in characters. The size must include space for the terminating
    /// null character.&lt;/param&gt;
    /// &lt;returns&gt;
    /// Standard HRESULT error code.
    /// &lt;/returns&gt;
    STDMETHOD(GetString)(
        UINT32 index,
        _Out_writes_z_(size) WCHAR* stringBuffer,
        UINT32 size
        ) PURE;
};
</code></pre>

<p>Я понимаю что у меня не правильно определены 2 метода: <code>GetLocaleName</code> и <code>GetString</code>.</p>

<p>Но у меня нет представления что мне передать туда, т.к. как выходная строка, не подходит, а при передачи как указатель на массив, происходит повреждение кучи. Как правильно эти 2 метода перенести в <code>c#</code>?</p>
