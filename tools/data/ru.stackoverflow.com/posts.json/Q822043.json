{"tags":["c#","winforms","webbrowser"],"owner":{"reputation":21,"user_id":295746,"user_type":"registered","profile_image":"https://www.gravatar.com/avatar/6297e3501ca9d8cc2484cdb6ed126ce0?s=128&d=identicon&r=PG&f=1","display_name":"Евгений Капешко","link":"https://ru.stackoverflow.com/users/295746/%d0%95%d0%b2%d0%b3%d0%b5%d0%bd%d0%b8%d0%b9-%d0%9a%d0%b0%d0%bf%d0%b5%d1%88%d0%ba%d0%be"},"is_answered":false,"view_count":71,"answer_count":1,"score":2,"last_activity_date":1525935519,"creation_date":1525243262,"question_id":822043,"link":"https://ru.stackoverflow.com/questions/822043/c-%d0%9e%d1%82%d0%bc%d0%b5%d0%bd%d0%b8%d1%82%d1%8c-%d0%b7%d0%b0%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b5-webbrowser-%d0%bf%d0%b5%d1%80%d0%b5%d1%85%d0%b2%d0%b0%d1%82%d0%be%d0%bc-wm-destroy-%d0%b8%d0%bb%d0%b8-wm-close","title":"C# - Отменить закрытие WebBrowser перехватом WM_DESTROY или WM_CLOSE","body":"<p>У меня есть форма с экземпляром WebBrowser на ней. В него загружается страница сайта, на которой есть ссылка вида '&lt;a onClick=\"self.close();\"&gt;Закрыть окно&lt;/a&gt;'.\nПри нажатии ее выдает сообщение, что скрипты пытается закрыть WebBrowser. Если согласиться, то WebBrowser просто зависает.\nПоэтому стоит задача перехватить и отменить это закрытие.</p>\n\n<p>После гугления нашел следующее решение. Расширить класс WebBrowser, чтобы перегрузить метод 'WndProc()', чтобы он ловил событие WM_PARENTNOTIFY, в котором передается WM_DESTROY. Однако, решение было предназначено для организации корректного закрытия формы браузера. В моем же случае мне нужно отменить закрытие и перейти по конкретному URL. Мне удается перехватить WM_DESTROY, но WebBrowser все равно убивается и зависает. Код использованного решения ниже:</p>\n\n<pre><code>public class ExtendedWebBrowser : WebBrowser\n  {\n    // Define constants from winuser.h\n    private const int WM_PARENTNOTIFY = 0x210;\n    private const int WM_DESTROY = 2;\n\n    public string BackUrl { get; set; };\n\n    protected override void WndProc(ref Message m)\n    {\n      switch (m.Msg)\n      {\n        case WM_PARENTNOTIFY:\n          if (!DesignMode)\n          {\n            if (m.WParam.ToInt32() == WM_DESTROY)\n            {\n              Navigate(BackUrl);\n            }\n          }\n          DefWndProc(ref m);\n          break;\n        default:\n          base.WndProc(ref m);\n          break;\n      }\n    }\n  }\n</code></pre>\n\n<p>Вопрос: Как предотвратить дальнейшую обработку WM_DESTROY или WM_CLOSE?</p>\n"}