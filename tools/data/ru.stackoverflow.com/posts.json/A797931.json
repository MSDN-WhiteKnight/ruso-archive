{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":2,"last_activity_date":1521001976,"creation_date":1521001976,"answer_id":797931,"question_id":797658,"body":"<p>Это никак не связано с кодировкой. Дело в том, что в Windows раскладка клавиатуры задается на уровне потоков. По некоторым причинам, <em>SendKeys</em> работает некорректно, если для потока, которому принадлежит целевое окно, установлена другая раскладка, чем для текущего потока - либо для русских, либо для английских букв будет генерироваться сообщение с несоответствующим скан-кодом. </p>\n\n<p>Эту проблему можно решить, изменив раскладку текущего потока так, чтобы они совпадали:</p>\n\n<pre><code>using System;\nusing System.Collections.Generic;\nusing System.ComponentModel;\nusing System.Runtime.InteropServices;\nusing System.Text;\nusing System.Diagnostics;\nusing System.Windows.Forms;\n\nnamespace WindowsFormsTest1\n{\n    public partial class Form1 : Form\n    {\n\n        [DllImport(\"user32.dll\")]\n        [return: MarshalAs(UnmanagedType.Bool)]\n        static extern bool SetForegroundWindow(IntPtr hWnd);\n\n        [DllImport(\"user32.dll\", SetLastError = true)]\n        static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);        \n\n        [DllImport(\"user32.dll\")]\n        static extern IntPtr GetKeyboardLayout(uint thid);        \n\n        [DllImport(\"user32.dll\", SetLastError = true)]\n        internal static extern IntPtr ActivateKeyboardLayout(IntPtr hkl, uint Flags);\n\n\n        public Form1()\n        {\n            InitializeComponent();\n        }\n\n\n        private void button1_Click(object sender, EventArgs e)\n        {\n            Process pr = Process.GetProcessesByName(\"notepad\")[0];\n            IntPtr hwnd = pr.MainWindowHandle;            \n\n            //получение идентификатора потока целевого окна\n            uint dummy = 0;\n            uint thid = GetWindowThreadProcessId(hwnd, out dummy);\n\n            //смена раскладки клавиатуры на раскладку целевого окна\n            IntPtr id = GetKeyboardLayout(thid); \n            ActivateKeyboardLayout(id, 0);           \n\n            SetForegroundWindow(hwnd);//передаем фокус окну\n            SendKeys.Send(\"Hello, мир\");//теперь должно сработать\n        }\n\n    }    \n\n}\n</code></pre>\n"}