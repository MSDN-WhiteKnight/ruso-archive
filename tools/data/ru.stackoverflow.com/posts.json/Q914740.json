{"tags":["c#","c++","struct","marshal"],"owner":{"reputation":57,"user_id":298234,"user_type":"registered","profile_image":"https://www.gravatar.com/avatar/af5d9f6f4869a68b0e52969946570084?s=128&d=identicon&r=PG&f=1","display_name":"keinHerz","link":"https://ru.stackoverflow.com/users/298234/keinherz"},"is_answered":true,"view_count":145,"accepted_answer_id":914756,"answer_count":2,"score":2,"last_activity_date":1549484290,"creation_date":1543811338,"last_edit_date":1549484290,"question_id":914740,"link":"https://ru.stackoverflow.com/questions/914740/%d0%92%d1%8b%d1%80%d0%b0%d0%b2%d0%bd%d0%b8%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%82%d1%83%d1%80-%d0%b4%d0%bb%d1%8f-%d1%86%d0%b5%d0%bb%d0%b5%d0%b2%d0%be%d0%b9-%d0%bf%d0%bb%d0%b0%d1%82%d1%84%d0%be%d1%80%d0%bc%d1%8b-x64","title":"Выравнивание структур для целевой платформы - x64","body":"<p>Возникла проблема с выравниванием структур. Есть код (не мой, данный код компилируется под x64) на C++:</p>\n\n<pre><code>#ifndef ETS2_TELEMETRY_COMMON_HPP\n#define ETS2_TELEMETRY_COMMON_HPP\n\n// This file contains \"Common definitions\" for this ETS2 telemetry plug-in.\n// This includes:\n// - Debug logging detail options\n// - Shared memory map struct layout\n// - [..]\n\n#define ETS2_PLUGIN_REVID                   5\n\n#define ETS2_PLUGIN_LOGGING_ON              0\n#define ETS2_PLUGIN_LOGGING_SHAREDMEMORY    0\n#define ETS2_PLUGIN_FILENAME_PREFIX \"C:\\ets2telem_\"\n\n#if ETS2_PLUGIN_LOGGING_ON == 1\n#define SDK_ENABLE_LOGGING\n#endif\n\n#define ETS2_PLUGIN_MMF_NAME TEXT(\"Local\\\\SimTelemetryETS2\")\n#define ETS2_PLUGIN_MMF_SIZE (16*1024)\n\n#define TRUCK_STRING_OFFSET 15*1024\n#define TRAILER_STRING_OFFSET TRUCK_STRING_OFFSET+64\n\ntypedef struct ets2TelemetryMap_s\n{\n    unsigned int time;\n    unsigned int paused;\n\n\n    struct\n    {\n        unsigned int ets2_telemetry_plugin_revision;\n        unsigned int ets2_version_major;\n        unsigned int ets2_version_minor;\n    } tel_revId;\n\n    // All variables per revision are packed into 1 struct.\n    // Newer revisions must contain identical struct layouts/lengths, even if variabeles become deprecated.\n    // Replaced/new variabeles should be added in seperate structs\n    struct\n    {\n        bool engine_enabled;\n        bool trailer_attached;\n\n        // vehicle dynamics\n        float speed;\n\n        float accelerationX;\n        float accelerationY;\n        float accelerationZ;\n\n        float coordinateX;\n        float coordinateY;\n        float coordinateZ;\n\n        float rotationX;\n        float rotationY;\n        float rotationZ;\n\n        // drivetrain essentials\n        int gear;\n        int gears;\n        int gearRanges;\n        int gearRangeActive;\n\n        float engineRpm;\n        float engineRpmMax;\n\n        float fuel;\n        float fuelCapacity;\n        float fuelRate;             // ! Not working\n        float fuelAvgConsumption;\n\n        // user input\n        float userSteer;\n        float userThrottle;\n        float userBrake;\n        float userClutch;\n\n        float gameSteer;\n        float gameThrottle;\n        float gameBrake;\n        float gameClutch;\n\n        // truck &amp; trailer\n        float truckWeight;\n        float trailerWeight;\n\n        int modelType[2];\n        int trailerType[2];         // ! deprecated\n\n    } tel_rev1;\n\n    struct\n    {\n        long time_abs;\n        int gears_reverse;\n\n        // Trailer ID &amp; display name\n        float trailerMass;\n        char trailerId[64];\n        char trailerName[64];\n\n        // Job information\n        int jobIncome;\n        int time_abs_delivery;\n        char citySrc[64];\n        char cityDst[64];\n        char compSrc[64];\n        char compDst[64];\n\n    } tel_rev2; \n\n    struct\n    {\n        int retarderBrake;\n        int shifterSlot;\n        int shifterToggle;\n        int fill;\n\n        bool cruiseControl;\n        bool wipers;\n\n        bool parkBrake;\n        bool motorBrake;\n\n        bool electricEnabled;\n        bool engineEnabled;\n\n        bool blinkerLeftActive;\n        bool blinkerRightActive;\n        bool blinkerLeftOn;\n        bool blinkerRightOn;\n\n        bool lightsParking;\n        bool lightsBeamLow;\n        bool lightsBeamHigh;\n        bool lightsAuxFront;\n        bool lightsAuxRoof;\n        bool lightsBeacon;\n        bool lightsBrake;\n        bool lightsReverse;\n\n        bool batteryVoltageWarning;\n        bool airPressureWarning;\n        bool airPressureEmergency;\n        bool adblueWarning;\n        bool oilPressureWarning;\n        bool waterTemperatureWarning;\n\n        float airPressure;\n        float brakeTemperature;\n        int fuelWarning;\n        float adblue;\n        float adblueConsumption;\n        float oilPressure;\n        float oilTemperature;\n        float waterTemperature;\n        float batteryVoltage;\n        float lightsDashboard;\n        float wearEngine;\n        float wearTransmission;\n        float wearCabin;\n        float wearChassis;\n        float wearWheels;\n        float wearTrailer;\n        float truckOdometer;\n        float cruiseControlSpeed;\n\n        // General info about the truck etc;\n        char truckMake[64];\n        char truckMakeId[64];\n        char truckModel[64];\n\n\n    } tel_rev3;\n\n    struct\n    {\n        float speedLimit;\n        float routeDistance;\n        float routeTime;\n        float fuelRange;\n        float gearRatiosForward[24];\n        float gearRatiosReverse[8];\n        float gearDifferential;\n        int gearDashboard;\n    } tel_rev4; // added in sdk1.5\n\n    struct\n    {\n        bool onJob;\n        bool jobFinished;\n    } tel_rev5;\n\n} ets2TelemetryMap_t;\n\n#endif\n</code></pre>\n\n<p>И есть следующий код на C# (тоже не мой) который получает данную структуру.</p>\n\n<pre><code>[StructLayout(LayoutKind.Explicit)]\n    public unsafe struct Ets2SdkData\n    {\n        [FieldOffset(0)]\n        public uint time;\n        [FieldOffset(4)]\n        public uint paused;\n\n        [FieldOffset(8)]\n        public uint ets2_telemetry_plugin_revision;\n        [FieldOffset(12)]\n        public uint ets2_version_major;\n        [FieldOffset(16)]\n        public uint ets2_version_minor;\n\n        //***** REVISION 1 ****** //\n\n\n        [FieldOffset(20), MarshalAs(UnmanagedType.ByValArray, SizeConst = 4)]\n        public byte[] flags;\n\n        //vehicle dynamics\n\n        [FieldOffset(24)]\n        public float speed;\n        [FieldOffset(28)]\n        public float accelerationX;\n        [FieldOffset(32)]\n        public float accelerationY;\n        [FieldOffset(36)]\n        public float accelerationZ;\n\n\n        [FieldOffset(40)]\n        public float coordinateX;\n        [FieldOffset(44)]\n        public float coordinateY;\n        [FieldOffset(48)]\n        public float coordinateZ;\n\n\n        [FieldOffset(52)]\n        public float rotationX;\n        [FieldOffset(56)]\n        public float rotationY;\n        [FieldOffset(60)]\n        public float rotationZ;\n\n        //drivetrain essentials\n\n        [FieldOffset(64)]\n        public int gear;\n        [FieldOffset(68)]\n        public int gears;\n        [FieldOffset(72)]\n        public int gearRanges;\n        [FieldOffset(76)]\n        public int gearRangeActive;\n\n        [FieldOffset(80)]\n        public float engineRpm;\n        [FieldOffset(84)]\n        public float engineRpmMax;\n\n        [FieldOffset(88)]\n        public float fuel;\n        [FieldOffset(92)]\n        public float fuelCapacity;\n        [FieldOffset(96)]\n        public float fuelRate;\n        [FieldOffset(100)]\n        public float fuelAvgConsumption;\n\n        // user input\n\n        [FieldOffset(104)]\n        public float userSteer;\n        [FieldOffset(108)]\n        public float userThrottle;\n        [FieldOffset(112)]\n        public float userBrake;\n        [FieldOffset(116)]\n        public float userClutch;\n\n\n        [FieldOffset(120)]\n        public float gameSteer;\n        [FieldOffset(124)]\n        public float gameThrottle;\n        [FieldOffset(128)]\n        public float gameBrake;\n        [FieldOffset(132)]\n        public float gameClutch;\n\n        //truck &amp; trailer\n\n        [FieldOffset(136)]\n        public float truckWeight;\n        [FieldOffset(140)]\n        public float trailerWeight;\n\n        [FieldOffset(144)]\n        public int modelOffset;\n        [FieldOffset(148)]\n        public int modelLength;\n\n        [FieldOffset(152)]\n        public int trailerOffset;\n        [FieldOffset(156)]\n        public int trailerLength;\n\n\n        //***** REVISION 2 ****** //\n        [FieldOffset(160)]\n        public int timeAbsolute;\n        [FieldOffset(164)]\n        public int gearsReverse;\n\n        [FieldOffset(168)]\n        public float trailerMass;\n        [FieldOffset(172), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] trailerId;\n        [FieldOffset(236), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] trailerName;\n\n        [FieldOffset(300)]\n        public int jobIncome;\n        [FieldOffset(304)]\n        public int jobDeadline;\n\n        [FieldOffset(308), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] jobCitySource;\n        [FieldOffset(372), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] jobCityDestination;\n\n        [FieldOffset(436), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] jobCompanySource;\n        [FieldOffset(500), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] jobCompanyDestination;\n\n        //***** REVISION 3 ****** //\n        [FieldOffset(564)]\n        public int retarderBrake;\n        [FieldOffset(568)]\n        public int shifterSlot;\n        [FieldOffset(572)]\n        public int shifterToggle;\n        [FieldOffset(576)]\n        public int fill;\n\n        [FieldOffset(580), MarshalAs(UnmanagedType.ByValArray, SizeConst = 24)]\n        public byte[] aux;\n        [FieldOffset(604)]\n        public float airPressure;\n        [FieldOffset(608)]\n        public float brakeTemperature;\n        [FieldOffset(612)]\n        public int fuelWarning;\n        [FieldOffset(616)]\n        public float adblue;\n        [FieldOffset(620)]\n        public float adblueConsumption;\n        [FieldOffset(624)]\n        public float oilPressure;\n        [FieldOffset(628)]\n        public float oilTemperature;\n        [FieldOffset(632)]\n        public float waterTemperature;\n        [FieldOffset(636)]\n        public float batteryVoltage;\n        [FieldOffset(640)]\n        public float lightsDashboard;\n        [FieldOffset(644)]\n        public float wearEngine;\n        [FieldOffset(648)]\n        public float wearTransmission;\n        [FieldOffset(652)]\n        public float wearCabin;\n        [FieldOffset(656)]\n        public float wearChassis;\n        [FieldOffset(660)]\n        public float wearWheels;\n        [FieldOffset(664)]\n        public float wearTrailer;\n        [FieldOffset(668)]\n        public float truckOdometer;\n        [FieldOffset(672)]\n        public float cruiseControlSpeed;\n\n        [FieldOffset(676), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] truckMake;\n        [FieldOffset(740), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] truckMakeId;\n        [FieldOffset(804), MarshalAs(UnmanagedType.ByValArray, SizeConst = 64)]\n        public byte[] truckModel;\n\n        // ***** REVISION 4 ****** //\n        [FieldOffset(868)]\n        public float speedLimit;\n\n        [FieldOffset(872)]\n        public float routeDistance;\n\n        [FieldOffset(876)]\n        public float routeTime;\n\n        [FieldOffset(880)]\n        public float fuelRange;\n\n        [FieldOffset(884), MarshalAs(UnmanagedType.ByValArray, SizeConst = 24)]\n        public float[] gearRatioForward;\n\n        [FieldOffset(980), MarshalAs(UnmanagedType.ByValArray, SizeConst = 8)]\n        public float[] gearRatioReverse;\n\n        [FieldOffset(1012)]\n        public float gearRatioDifferential;\n\n        [FieldOffset(1016)]\n        public int gearDashboard;\n\n        [FieldOffset(1020)]\n        public byte onJob;\n        [FieldOffset(1021)]\n        public byte jobFinished;\n\n\n        public bool GetBool(Ets2SdkBoolean i)\n        {\n            if (i == Ets2SdkBoolean.TrailerAttached)\n                return flags[1] &gt; 0;\n            return aux[(int)i] &gt; 0;\n        }\n    }\n</code></pre>\n\n<p>Данный код на C#, работает, если в свойствах проекта выставлено целевая платформа - \"x86\", но если ее поменять на \"x64\" (что мне и нужно сделать), то при выполнении кода, сразу же начинаются ошибки типа: </p>\n\n<blockquote>\n  <p>Не удалось загрузить тип \"Ets2SdkData2\"..., так как он содержит поле объекта со смещением 20, которое неверно выровнено или перекрыто полем, не представляющим объект.\"</p>\n</blockquote>\n\n<p>Из описания ошибки, как я понял, что не правильно указан \"<strong>FieldOffset</strong>\" на всех переменных типа \"<strong>byte</strong>[]\". </p>\n\n<p>Тут и встает вопрос, если для проекта с целевой платформой - x86, свойство \"FieldOffset\" везде задано правильно и программа получает все данные, то какой он должен быть \"FieldOffset\" в проекте с целевой платформой - x64?</p>\n"}