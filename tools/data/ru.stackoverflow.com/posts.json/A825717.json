{"owner":{"reputation":16068,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":0,"last_activity_date":1525935519,"creation_date":1525935519,"answer_id":825717,"question_id":822043,"body":"<p>Вместо того, чтобы переопределять <em>WM_DESTROY</em> (которое вызывается когда уже слишком поздно), нужно переопределить функцию close на уровне JavaScript. Для этого нужно будет добавить ссылку на COM объект Microsoft HTML Object Library и воспользоваться интерфейсом <em>IHTMLScriptElement</em> для добавления в каждую загружаемую страницу сценария со своей функцией close. В старых версиях IE это можно сделать присваиванием <code>window.close = function ()...</code>, но в IE11 это почему-то не работает, хотя то же самое достигается просто определением своей функции close.</p>\n\n<p>Чтобы форма могла получать уведомления от JavaScript через вызовы <em>window.external</em>, нужно будет добавить к ней атрибут <em>ComVisible</em> и присвоить ее свойству веб браузера <em>ObjectForScripting</em>. Пример:</p>\n\n<pre><code>using System;\nusing System.Collections.Generic;\nusing System.ComponentModel;\nusing System.Text;\nusing System.Windows.Forms;\nusing System.Security.Permissions;\nusing System.Runtime.InteropServices;\n\nnamespace WindowsFormsTest1\n{\n    [PermissionSet(SecurityAction.Demand, Name = \"FullTrust\")]\n    [System.Runtime.InteropServices.ComVisibleAttribute(true)]\n    public partial class Form1 : Form\n    {\n        public void NotifyClose()\n        {\n            //попытка закрытия WebBrowser...\n        } \n\n        public Form1()\n        {\n            InitializeComponent();\n            webBrowser1.ObjectForScripting = this;\n        }        \n\n        private void webBrowser1_DocumentCompleted(object sender, WebBrowserDocumentCompletedEventArgs e)\n        {\n            // here we override the functionality of window.close\n            HtmlElement head = webBrowser1.Document.GetElementsByTagName(\"head\")[0];\n            HtmlElement scriptEl = webBrowser1.Document.CreateElement(\"script\");\n            mshtml.IHTMLScriptElement element = (mshtml.IHTMLScriptElement)scriptEl.DomElement;\n            try\n            {\n                element.text = \"function close() { window.external.NotifyClose();  } \";\n                head.AppendChild(scriptEl);\n            }\n            finally\n            {\n                Marshal.ReleaseComObject(element);\n            }\n        }  \n    }     \n\n}\n</code></pre>\n\n<p><a href=\"https://social.microsoft.com/Forums/en-US/c9384257-f83c-4186-a59d-cb991273211d/webbrowser-control-and-windowclosing-event?forum=Offtopic\" rel=\"nofollow noreferrer\">Источник</a></p>\n"}