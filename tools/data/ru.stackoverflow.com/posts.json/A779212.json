{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":true,"score":3,"last_activity_date":1517592986,"last_edit_date":1517592986,"creation_date":1517569128,"answer_id":779212,"question_id":779090,"body":"<p>Во первых, в данном коде неправильно измеряется размер для массива ссылочных типов. Код:</p>\n\n<pre><code>var size = GC.GetTotalMemory(true);\nvar arr = new object[count];\n\nfor (var i = 0; i &lt; count; ++i)\n{\n        arr[i] = new object();\n}\n\nvar mem = GC.GetTotalMemory(true) - size;\n</code></pre>\n\n<p>Измеряет память под массив ссылок + память по объекты. Надо так:</p>\n\n<pre><code>var arr = new object[count];\nvar size = GC.GetTotalMemory(true);\n\nfor (var i = 0; i &lt; count; ++i)\n{\n        arr[i] = new object();\n}\n\nvar mem = GC.GetTotalMemory(true) - size;\n</code></pre>\n\n<p>Во вторых, арифметика <code>Размер C = Размер object + 2 * Размер int</code> не работает: все несколько сложнее. </p>\n\n<ol>\n<li><p>В CLR существует минимальный размер объекта, см. <a href=\"https://github.com/dotnet/coreclr/blob/master/src/vm/object.h\" rel=\"nofollow noreferrer\">object.h</a></p>\n\n<pre><code>//\n// The generational GC requires that every object be at least 12 bytes\n// in size.   \n\n#define MIN_OBJECT_SIZE     (2*sizeof(BYTE*) + sizeof(ObjHeader))\n</code></pre>\n\n<p>Для 64-разрядной версии минимальный размер 2 * 8 + 8 = 24. Размер типа, меньшего 24 байта, дополняется до 24. </p>\n\n<p>(Определение ObjHeader здесь: <a href=\"https://github.com/dotnet/coreclr/blob/master/src/gc/env/gcenv.object.h\" rel=\"nofollow noreferrer\">https://github.com/dotnet/coreclr/blob/master/src/gc/env/gcenv.object.h</a>)</p></li>\n<li><p>Размер служебного блока, добавляемого к любому ссылочному типу, равен 16 байт (для x86 - 8 байт, см. например <a href=\"https://www.codeproject.com/Articles/20481/NET-Type-Internals-From-a-Microsoft-CLR-Perspecti#4\" rel=\"nofollow noreferrer\">здесь</a>, для x64 в два раза больше).  </p></li>\n<li><p>Кроме того, предположительно, работает дополнение размера до числа, кратного 8. </p></li>\n</ol>\n\n<p>Таким образом:</p>\n\n<blockquote>\n  <p>Размер объекта с 1 int полем = 24 байта<br>\n  Размер объекта с 2 int полями = 24 байта<br>\n  Размер объекта с 3 int полями = 32 байта  </p>\n</blockquote>\n"}