{"owner":{"reputation":16068,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":1,"last_activity_date":1522870340,"creation_date":1522870340,"answer_id":809699,"question_id":809388,"body":"<p>Для отображения диалогового окна можно использовать функцию <em>CredUIPromptForWindowsCredentials</em>, а для проверки логина и пароля - <em>PrincipalContext</em> (добавить ссылку на <em>System.DirectoryServices.AccountManagement</em>).</p>\n\n<pre><code>using System;\nusing System.Collections.Generic;\nusing System.ComponentModel;\nusing System.Data;\nusing System.DirectoryServices.AccountManagement;\nusing System.Text;\nusing System.Runtime.InteropServices;\nusing System.Windows.Forms;\n\nnamespace WinformsTest\n{\n    public partial class Form1 : Form\n    {\n        //https://www.pinvoke.net/default.aspx/credui.creduipromptforwindowscredentials\n        [DllImport(\"credui.dll\", CharSet = CharSet.Unicode)]\n        private static extern uint CredUIPromptForWindowsCredentials(ref CREDUI_INFO notUsedHere,\n          int authError,\n          ref uint authPackage,\n          IntPtr InAuthBuffer,\n          uint InAuthBufferSize,\n          out IntPtr refOutAuthBuffer,\n          out uint refOutAuthBufferSize,\n          ref bool fSave,\n          uint flags);\n\n        [DllImport(\"credui.dll\", CharSet = CharSet.Auto)]\n        private static extern bool CredUnPackAuthenticationBuffer(int dwFlags, IntPtr pAuthBuffer, uint cbAuthBuffer, \n            StringBuilder pszUserName, ref int pcchMaxUserName, StringBuilder pszDomainName, \n            ref int pcchMaxDomainame, StringBuilder pszPassword, ref int pcchMaxPassword\n            );\n\n        [DllImport(\"ole32.dll\")]\n        public static extern void CoTaskMemFree(IntPtr ptr);\n\n        public Form1()\n        {\n            InitializeComponent();\n        }\n\n        bool CheckCredentials()\n        {\n            bool save = false;\n            int errorcode = 0;\n            uint dialogReturn;\n            uint authPackage = 0;\n            IntPtr outCredBuffer;\n            uint outCredSize;\n\n            CREDUI_INFO credui = new CREDUI_INFO();\n            credui.cbSize = Marshal.SizeOf(credui);\n            credui.pszCaptionText = \"Авторизация\";\n            credui.pszMessageText = \"Введите логин и пароль\";\n            credui.hwndParent = this.Handle;\n\n            //Show dialog\n            dialogReturn = CredUIPromptForWindowsCredentials(ref credui,\n            errorcode, ref authPackage, (IntPtr)0, 0, out outCredBuffer, out outCredSize, ref save,\n            0x1 /*CREDUIWIN_GENERIC*/);\n\n            if (dialogReturn != 0) return false; //Cancel pressed\n\n            var usernameBuf = new StringBuilder(100);\n            var passwordBuf = new StringBuilder(100);\n            var domainBuf = new StringBuilder(100);\n\n            int maxUserName = 100;\n            int maxDomain = 100;\n            int maxPassword = 100;\n\n            //Validate credentials\n            if (CredUnPackAuthenticationBuffer(0, outCredBuffer, outCredSize, usernameBuf,\n                ref maxUserName, domainBuf, ref maxDomain, passwordBuf, ref maxPassword))\n            {\n                CoTaskMemFree(outCredBuffer);\n\n                using (PrincipalContext context = new PrincipalContext(ContextType.Machine)) \n                {\n                    bool valid;\n                    try\n                    {\n                        valid = context.ValidateCredentials(usernameBuf.ToString(), passwordBuf.ToString());\n                    }\n                    catch (System.DirectoryServices.AccountManagement.PrincipalOperationException ex)\n                    {\n                        MessageBox.Show(ex.ToString(), \"Ошибка\");\n                        valid = false;\n                    }\n                    return valid;\n                }\n            }\n            else throw new ApplicationException(\"CredUnPackAuthenticationBuffer failed\");\n\n        }\n\n        private void button1_Click(object sender, EventArgs e)\n        {\n            if (!CheckCredentials()) MessageBox.Show(\"Не удалось авторизоваться\");                        \n\n        }\n    }\n\n    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]\n    public struct CREDUI_INFO\n    {\n        public int cbSize;\n        public IntPtr hwndParent;\n        public string pszMessageText;\n        public string pszCaptionText;\n        public IntPtr hbmBanner;\n    }\n\n\n}\n</code></pre>\n"}