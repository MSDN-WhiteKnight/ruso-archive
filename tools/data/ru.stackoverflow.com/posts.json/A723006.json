{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":2,"last_activity_date":1506352002,"creation_date":1506352002,"answer_id":723006,"question_id":722795,"body":"<p>Я полагаю, суть вопроса в методике отделения \"мусора\" от нормальных процессов Excel. Умея это, уже можно что-то смастерить: удалять мусорные процессы при запуске основной программы, или периодически - фоновым сервисом, когда основная программа закрыта.</p>\n\n<p>Наиболее правильное решение: добавлять Id всех создаваемых Interop-процессов в БД, при корректном их завершении - удалять. Соответственно, при некорректном завершении приложения в БД останутся Id мертвых процессов, которые можно на следующем запуске прибить (предварительно убедившись, что это все еще существующие процессы Excel, так как они могли быть прибиты чем-то другим и те же Id уже переиспользованы системой для другой программы). </p>\n\n<p>Но, если хочется метод попроще, можно считать \"мусором\" любой процесс Excel, не имеющий видимого главного окна:</p>\n\n<pre><code>using System.Diagnostics;\nusing System.Runtime.InteropServices;\n\nstatic class Program \n{\n    [DllImport(\"user32.dll\")]\n    [return: MarshalAs(UnmanagedType.Bool)]\n    static extern bool IsWindowVisible(IntPtr hWnd);\n\n    public static bool IsProcessDead(Process pr)\n    {\n            IntPtr hwnd = pr.MainWindowHandle;\n            if (hwnd == IntPtr.Zero) return true;\n\n            return !IsWindowVisible(hwnd);            \n    }\n\n\n\n    void ClearProcesses()\n    {                \n            Process[] prs=Process.GetProcessesByName(\"excel\");\n            foreach (Process proc in prs)\n            {\n                if(IsProcessDead(proc))proc.Kill();\n            }\n     }\n\n}\n</code></pre>\n\n<p>Если на целевой машине нет других программ, использующих невидимые эксели для своих целей, это можно считать нормальным допущением.</p>\n"}