{"owner":{"reputation":16058,"user_id":240512,"user_type":"registered","profile_image":"https://i.stack.imgur.com/Ew6lG.png?s=128&g=1","display_name":"MSDN.WhiteKnight","link":"https://ru.stackoverflow.com/users/240512/msdn-whiteknight"},"is_accepted":false,"score":5,"last_activity_date":1554981215,"last_edit_date":1554981215,"creation_date":1554977443,"answer_id":968320,"question_id":966846,"body":"<p>Вот пример записи значения строкового свойства в набор свойств Structured Storage: </p>\n\n<pre><code>using System;\nusing System.Collections;\nusing System.Runtime.InteropServices;\n\nnamespace ConsoleApplication1\n{\n    class Program\n    {\n        [DllImport(\"ole32.dll\")]\n        static extern int StgOpenStorageEx(\n            [MarshalAs(UnmanagedType.LPWStr)] string pwcsName, \n            uint grfMode,\n            uint stgfmt, \n            uint grfAttrs,\n            IntPtr  pStgOptions, \n            IntPtr reserved2, \n            [In] ref Guid riid,\n            out IPropertySetStorage ppObjectOpen);                \n\n        const uint STGM_DIRECT = 0;\n        const uint STGM_READWRITE = 0x2;\n        const uint STGM_SHARE_EXCLUSIVE = 0x10;\n        const uint STGFMT_ANY = 4;\n        const uint VT_LPWSTR = 31;\n        const uint PID_FIRST_USABLE = 2;\n        const uint STGC_DEFAULT = 0;\n        const uint PRSPEC_LPWSTR = 0;\n\n        static void Main(string[] args)\n        {\n            IPropertySetStorage pPropSetStg = null;\n            IPropertyStorage pPropStg = null;\n            int hr;\n            PROPSPEC propspec=new PROPSPEC();\n            PROPVARIANT propvarWrite=new PROPVARIANT();\n            Guid guidPropertySetStorage = typeof(IPropertySetStorage).GUID;\n\n            string path = \"c:\\\\Test\\\\Test.stg\"; //путь к файлу            \n            Guid fmtid = Guid.Parse(\"F29F85E0-4FF9-1068-AB91-08002B27B3D9\"); //GUID набора свойств\n\n            try\n            {\n                //открываем файл\n                hr = StgOpenStorageEx(path, STGM_READWRITE | STGM_SHARE_EXCLUSIVE, STGFMT_ANY,\n                    0, IntPtr.Zero, IntPtr.Zero, ref guidPropertySetStorage, out pPropSetStg);\n                if (hr != 0) throw Marshal.GetExceptionForHR(hr);\n\n                //открываем набор свойств\n                pPropSetStg.Open(fmtid, STGM_DIRECT | STGM_READWRITE | STGM_SHARE_EXCLUSIVE, out pPropStg);\n\n                //имя свойства...\n                propspec.ulKind = PRSPEC_LPWSTR;\n                propspec.unionmember = Marshal.StringToHGlobalUni(\"Property\");\n\n                //значение свойства...\n                propvarWrite.vt = (ushort)VT_LPWSTR;\n                propvarWrite.unionmember = Marshal.StringToHGlobalUni(\"Value\");\n\n                //записываем свойство\n                pPropStg.WriteMultiple(1, ref propspec, ref propvarWrite, PID_FIRST_USABLE);\n                pPropStg.Commit(STGC_DEFAULT);                                \n            }\n            finally\n            {\n                //освобождение ресурсов\n                if (propspec.unionmember != IntPtr.Zero) Marshal.FreeHGlobal(propspec.unionmember);\n                if (propvarWrite.unionmember != IntPtr.Zero) Marshal.FreeHGlobal(propvarWrite.unionmember);\n                if (pPropSetStg != null) Marshal.ReleaseComObject(pPropSetStg);\n                if (pPropStg != null) Marshal.ReleaseComObject(pPropStg);\n            }\n\n        }\n\n    }        \n\n    [ComImport]\n    [Guid(\"00000138-0000-0000-C000-000000000046\")]\n    [InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]\n    public interface IPropertyStorage\n    {\n        void a();\n        void WriteMultiple(uint cpspec, ref PROPSPEC rgpspec, ref PROPVARIANT rgpropvar, uint propidNameFirst);\n        void b( );\n        void c( );\n        void d();\n        void e();\n        void Commit(uint grfCommitFlags);\n        void f();\n        void g();\n        void h( );\n        void x();\n        void y();\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    public struct PROPSPEC\n    {       \n        public uint ulKind;\n        public IntPtr unionmember;\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    public struct PROPVARIANT\n    {        \n        public ushort vt;        \n        public byte wReserved1;        \n        public byte wReserved2;        \n        public uint wReserved3;\n        public IntPtr unionmember;\n    }       \n\n    [ComImport]\n    [Guid(\"0000013A-0000-0000-C000-000000000046\")]\n    [InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]\n    public interface IPropertySetStorage\n    {\n        void Create(ref Guid rfmtid, ref Guid pClsid,  uint grfFlags,  uint grfMode, out IPropertyStorage ppprstg);\n        void Open( ref Guid rfmtid,  uint grfMode, out IPropertyStorage ppprstg);\n        void Delete(ref Guid rfmtid);\n        void f();\n    }  \n\n\n}\n</code></pre>\n\n<p>Создание нового набора свойств:</p>\n\n<pre><code>pPropSetStg.Create(fmtid, new Guid(), 0,STGM_DIRECT | STGM_READWRITE | STGM_SHARE_EXCLUSIVE, out pPropStg);\n</code></pre>\n\n<p>Источник: <a href=\"https://docs.microsoft.com/ru-ru/windows/desktop/Stg/writeread-sample\" rel=\"noreferrer\">https://docs.microsoft.com/ru-ru/windows/desktop/Stg/writeread-sample</a></p>\n"}