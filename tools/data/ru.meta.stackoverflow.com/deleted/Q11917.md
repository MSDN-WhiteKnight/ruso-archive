---
title: "Chat on Socket.io"
se.owner.user_id: 467193
se.owner.display_name: "bot"
se.owner.link: "https://ru.meta.stackoverflow.com/users/467193/bot"
se.link: "https://ru.meta.stackoverflow.com/questions/11917/chat-on-socket-io"
se.question_id: 11917
se.post_type: question
---
<p>я разрабатываю чат на сокетах, у меня всё идёт отлично, но у меня появилась проблема: когда пользователь закрепляет сообщения, то при каждом новом закреплении, количество закреплёных сообщений увеличиваются то есть, дублируются, почему так? (NODE.js) Вот код на сервере:</p>
<pre><code>
const express = require('express');
const app = express();
const http = require('http');
const server = http.createServer(app);
const { Server } = require(&quot;socket.io&quot;);
const io = new Server(server);
let numb = 1;
app.get('/', (req, res) =&gt; {
  res.sendFile(__dirname + '/index.html');
});
io.on('connection', (socket) =&gt; {
  alert('a user connected');
    socket.broadcast.emit('hello', &quot;BOT: у нас новый пользователь&quot;);
  socket.on('disconnect', () =&gt; {
        console.log('disconnected user');
    socket.broadcast.emit('goodbye', &quot;BOT: пользователь ушел из чата&quot;);
    });
  socket.on('typing', us =&gt; {
        socket.broadcast.emit('typing', `✍${us} пишет...`);
        console.log(&quot;type&quot;);
    });
//Здесь событие закрепления
  socket.on('pin', function (data) {
        io.emit('pin', {
            id: data.id,
            text: data.text
        });
        console.log(`message ${data.id} was pinned with text: &quot;${data.text}&quot;`);
    });
    socket.on('chat message', function (msg) {
    console.log(msg.name + &quot;: &quot; + msg.message);
        io.emit('chat message', {
            message: msg.message,
            name: msg.name,
            ID: msg.ID
        });
  });
});
server.listen(1000, () =&gt; {
  console.log(' &gt;_     ·————listening on *:1000————·');
});
</code></pre>
<p>Код на клиенте (javascript):
HTML:</p>
<pre><code>&lt;div id=&quot;msgs&quot;&gt;
    &lt;div id=&quot;pinned_msgs&quot;&gt;&lt;!--здесь хранятся все закреплённые сообщения--&gt;&lt;/div&gt;
      &lt;ul id=&quot;messages&quot;&gt;
            
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;form id=&quot;form&quot; action=&quot;&quot;&gt;
            &lt;input type=&quot;text&quot; id=&quot;user&quot; autocomplete=off placeholder=&quot;name...&quot;&gt;&lt;br&gt;
      &lt;input id=&quot;input&quot; autocomplete=&quot;off&quot; placeholder=&quot;message...&quot;/&gt;&lt;button&gt;Send&lt;/button&gt;
            &lt;input type=&quot;submit&quot;&gt;
    &lt;/form&gt;
</code></pre>
<p>JS:</p>
<pre><code>//Когда мы получаем сообщения
    socket.on('chat message', function(msg) {
        let tim = new Date();
        let year = tim.getFullYear();
        let day = tim.getDate();
    let month = tim.getMonth();
    let hour = tim.getHours();
        let minute = tim.getMinutes();
    let time = `${day}/${month}/${year} (${hour}:${minute})`;
    var item = document.createElement('li');
        item.id = msg.ID;
        item.style.width = &quot;fit-content&quot;;
    item.innerHTML = &quot;&lt;b&gt;&lt;i&gt;&quot; + msg.name + &quot;&lt;/i&gt;&lt;/b&gt;: &quot; + &quot;&lt;message&gt;&quot; + msg.message + &quot;&lt;/message&gt;&lt;br&gt; &lt;time id='d'&gt;&quot; + time + &quot;&lt;/time&gt;&quot;;
    messages.appendChild(item);
    //window.scrollTo(10, document.body.scrollHeight);

let h = $(&quot;#msgs&quot;).get(0).scrollHeight;
$(&quot;#msgs&quot;).animate({
    scrollTop: h
}, 500);
//Когда мы фокусируемся на сообщение которое хотим закрепить
document.querySelector(&quot;#messages&quot;).onclick = (f) =&gt; {
      let Id = &quot;&quot;;
            let tag = f.target;
            if (tag.tagName != &quot;LI&quot;) {
                Id = tag.parentNode.id;
            } else {
                Id = tag.id;
            }
            let parentControl = document.querySelector(`#${Id}`);
//Создаём меню
parentControl.addEventListener('click',function(ev){
    ev.preventDefault();
    new contextualMenu({
      docked:false,
      items:[
        {
                    title:'Удалить',
                    tip: '',
                    icon:'https://Contextmenu-3.volodya-bot-developer.repl.co/delete.svg',
                    children: [
                        {
                            title: 'У себя',
                            tip:'',
                            icon: 'https://Contextmenu-3.volodya-bot-developer.repl.co/delete.svg',
                            onclick: function(){
                        
                            }
                        },
                        {
                            title: 'У всех',
                            tip:'',
                            icon: 'https://Contextmenu-3.volodya-bot-developer.repl.co/delete.svg',
                            onclick: function(){
                        
                            }
                        }
                    ]
                },
                /*{
                    seperator: true
                },*/
                {
                    title:'Прореагировать',
                    tip:'', 
                    icon:'https://Contextmenu-3.volodya-bot-developer.repl.co/add_sm.svg', 
                    children: [
            {
                            title:'😂',
                            tip:'смешно',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
            {
                            title:'🚀',
                            tip:'круто',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
            {
                            title:'❌',
                            tip:'нет',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title:'👌',
                            tip:'точно',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title: '🔥',
                            tip:'вау',
                            icon:'',
                            onclick: function(){}
                                    }
 ,                      {
                            title: '💪',
                            tip:'неплохо',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },                      {title: '😭',
                         tip:'печалька',
                         icon:'',
                         onclick: function(){
                             
                         }
                        },                      {
                            title: '🥰',
                            tip: 'люблю',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },                      {
                            title: '🥳',
                            tip: 'с днём рождения',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title: '🤩',
                            tip: 'ого',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title: '😐',
                            tip: 'уупс',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title: '🤔',
                            tip: 'надо подумать',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                        {
                            title: '😱',
                            tip: 'ужас',
                            icon:'',
                            onclick: function(){
                                
                            }
                        },
                         {
                             title: '🤬',
                             tip: 'чтоб тебя',
                             icon:'',
                             onclick: function(){
                                
                            }
                         }
                    ]},
          {
                        title:'Копировать',
                        tip:'Ctrl+C',
                        icon:'https://Contextmenu-3.volodya-bot-developer.repl.co/copy.svg',
                        onclick: function(){}
                    },
          /*{
                        seperator:true
                    },*/
          {
                        title:'Закрепить',
                        tip:'',
                        icon:'https://Contextmenu-3.volodya-bot-developer.repl.co/pin.svg',
                        onclick: function(){
                            let Text = prompt(&quot;Введите текст-заголовок для закрепления&quot;, &quot;текст&quot;);
                            if (Text == null) {
                                return;
                            } else {
              socket.emit('pin', {
                                id: Id,
                                text: Text
                            });
                                Id = null;
                                Text = null;
                            socket.on('pin', function (data) {
                  let pin_msg = document.createElement(&quot;a&quot;);
                                pin_msg.href = `#${data.id}`;
                                pin_msg.innerHTML = data.text + &quot;&lt;remove&gt;❌&lt;/remove&gt;&lt;br&gt;&quot;;
                                
                                document.querySelector(&quot;#pinned_msgs&quot;).appendChild(pin_msg);
                                pin_msg = null;
                                let h = $(&quot;#pinned_msgs&quot;).get(0).scrollHeight;
$(&quot;#pinned_msgs&quot;).animate({
    scrollTop: h
}, 500);
                                document.querySelector(&quot;remove&quot;).onclick = (rt) =&gt; {
                                    let mef = rt.target;
                                    let pn = mef.parentNode;
                    //alert(pn);
                                    document.querySelector(&quot;#pinned_msgs&quot;).removeChild(pn);
                                }
                  });
                            }
                        }
                    },
          {
                        title:'Редактировать',
                        tip:'',
                        icon:'https://Contextmenu-3.volodya-bot-developer.repl.co/cha.svg',
                        children: [
                        {
                            title: 'У себя',
                            tip:'',
                            icon: 'https://Contextmenu-3.volodya-bot-developer.repl.co/cha.svg',
                            onclick: function(){
                            
                }
                        },
                        {
                            title: 'У всех',
                            tip: '',
                            icon: 'https://Contextmenu-3.volodya-bot-developer.repl.co/cha.svg',
                            onclick: function(){
                            
                        }
                        }
                        ]
                    },
                    {
                        title: 'Комментировать',
                        tip:'',
                        icon: 'https://Contextmenu-3.volodya-bot-developer.repl.co/com.svg',
                        onclick: function(){
                            
                        }
                    }
        ]
            });
        });
        }
});
</code></pre>
<p>Ссылка: <a href="https://Chat-on-socketio.volodya-bot-developer.repl.co" rel="nofollow noreferrer">chat example</a></p>
<p>Внимание: чтобы вызвать меню, нужно сначала 1 раз нажать на сообщение а потом второй раз ещё раз на это же сообщение</p>
